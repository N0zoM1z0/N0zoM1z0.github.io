<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="慢慢磨吧… x32dbg再开一次第一遍熟悉了大概流程 接下来就是逐步完善细节 函数没有任何难点 难的在于各个结构体的结构以及偏移量！！！还有函数层次关系… IDA和x32dbg的base是一样的 互相照着看方便~ 笑死 先前逆的是2… 教程用的2.2… 又下了一个 确实各个数据应该都能对上了 几个关键结构体FilePackVer地址:结构:46 69 6C 65 50 61 63 6B 56 65">
<meta property="og:type" content="article">
<meta property="og:title" content="万华镜逆向">
<meta property="og:url" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/index.html">
<meta property="og:site_name" content="N0zoM1z0">
<meta property="og:description" content="慢慢磨吧… x32dbg再开一次第一遍熟悉了大概流程 接下来就是逐步完善细节 函数没有任何难点 难的在于各个结构体的结构以及偏移量！！！还有函数层次关系… IDA和x32dbg的base是一样的 互相照着看方便~ 笑死 先前逆的是2… 教程用的2.2… 又下了一个 确实各个数据应该都能对上了 几个关键结构体FilePackVer地址:结构:46 69 6C 65 50 61 63 6B 56 65">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-1.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-2.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-3.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-4.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-5.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-6.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-7.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-8.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-9.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-10.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-11.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-12.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-13.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-14.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-15.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-16.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-17.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-18.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-19.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-20.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-21.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-22.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-23.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-24.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-25.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-26.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-27.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-28.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-29.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-30.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-31.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-32.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-33.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-34.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-35.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-36.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/flow.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-37.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-38.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-39.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-40.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-41.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-42.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-43.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-45.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-46.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-47.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-48.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-49.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-50.png">
<meta property="og:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-51.png">
<meta property="article:published_time" content="2024-03-03T07:03:39.000Z">
<meta property="article:modified_time" content="2024-03-03T14:14:28.299Z">
<meta property="article:author" content="N0zoM1z0">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>万华镜逆向</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.1.1"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/N0zoM1z0">Projects</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/lqb-OI-Practice-Plan/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/&text=万华镜逆向"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/&title=万华镜逆向"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/&is_video=false&description=万华镜逆向"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=万华镜逆向&body=Check out this article: http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/&title=万华镜逆向"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/&title=万华镜逆向"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/&title=万华镜逆向"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/&title=万华镜逆向"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/&name=万华镜逆向&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/&t=万华镜逆向"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%87%A0%E4%B8%AA%E5%85%B3%E9%94%AE%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-number">1.</span> <span class="toc-text">几个关键结构体</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#FilePackVer"><span class="toc-number">1.1.</span> <span class="toc-text">FilePackVer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HashData"><span class="toc-number">1.2.</span> <span class="toc-text">HashData</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HashVer"><span class="toc-number">1.3.</span> <span class="toc-text">HashVer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Decrypt2DataHead"><span class="toc-number">1.4.</span> <span class="toc-text">Decrypt2DataHead</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FileEntry"><span class="toc-number">1.5.</span> <span class="toc-text">FileEntry</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BF%91%E6%9C%882-%E6%B5%81%E7%A8%8B%E6%A2%B3%E7%90%86"><span class="toc-number">2.</span> <span class="toc-text">近月2 流程梳理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#FilePack"><span class="toc-number">2.1.</span> <span class="toc-text">FilePack</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">2.1.1.</span> <span class="toc-text">文件读取初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E8%A7%A3%E5%AF%86"><span class="toc-number">2.1.2.</span> <span class="toc-text">文件解密</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%87%E5%8D%8E%E9%95%9C5"><span class="toc-number">3.</span> <span class="toc-text">万华镜5</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#decrypt4"><span class="toc-number">3.1.</span> <span class="toc-text">decrypt4</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9E%E6%BA%AF%E6%89%BEkey"><span class="toc-number">3.1.1.</span> <span class="toc-text">回溯找key[]</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%A7%A3%E5%AF%86%E4%BB%A3%E7%A0%81"><span class="toc-number">4.</span> <span class="toc-text">解密代码</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E6%9C%80%E5%90%8E"><span class="toc-number">5.</span> <span class="toc-text">写在最后</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        万华镜逆向
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">N0zoM1z0</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-03-03T07:03:39.000Z" class="dt-published" itemprop="datePublished">2024-03-03</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <p>慢慢磨吧… x32dbg再开一次<br>第一遍熟悉了大概流程 接下来就是逐步完善细节</p>
<p>函数没有任何难点 难的在于各个结构体的结构以及偏移量！！！<br>还有函数层次关系…</p>
<p>IDA和x32dbg的base是一样的 互相照着看方便~</p>
<p>笑死 先前逆的是2… 教程用的2.2… 又下了一个 确实各个数据应该都能对上了</p>
<h1 id="几个关键结构体"><a href="#几个关键结构体" class="headerlink" title="几个关键结构体"></a>几个关键结构体</h1><h2 id="FilePackVer"><a href="#FilePackVer" class="headerlink" title="FilePackVer"></a>FilePackVer</h2><p>地址:<br>结构:<br>46 69 6C 65 50 61 63 6B 56 65 72 33 2E 31 00 00<br>12 00 00 00 35 01 4D 02 00 00 00 00</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">FilePack</span>&#123;</span><br><span class="line">    <span class="type">char</span> sign[<span class="number">0x10</span>];</span><br><span class="line">    DWORD size;</span><br><span class="line">    QWORD EntryPoint;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="HashData"><a href="#HashData" class="headerlink" title="HashData"></a>HashData</h2><p>结构:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">HashData</span>&#123;</span><br><span class="line">    <span class="type">char</span> sign[<span class="number">0x20</span>]; <span class="comment">//8hr...</span></span><br><span class="line">    DWORD offset; <span class="comment">// 028D</span></span><br><span class="line">    <span class="type">char</span> data[<span class="number">0x100</span>]; <span class="comment">//256字节数据</span></span><br><span class="line">    DWORD unk; <span class="comment">//先前检验data后一个字节 &lt;0||&gt;8就设置为0</span></span><br><span class="line">    <span class="type">char</span> Blank[<span class="number">0x2F8</span>] <span class="comment">//空字节占位</span></span><br><span class="line">    FilePack filepack; <span class="comment">// FilePack结构体</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="HashVer"><a href="#HashVer" class="headerlink" title="HashVer"></a>HashVer</h2><p>地址: 0296C5B0<br>结构:<br>48 61 73 68 56 65 72 31 2E 34 00 00 00 00 00 00<br>00 01 00 00 12 00 00 00 48 00 00 00 49 02 00 00<br>01 00 00 00 04 00 00 00 00 00 00 00 00 00 00 00<br>00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00<br>00 00 00 00 BE 77 EB 74 8E 27 A8 8B A1 45 8E A6</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">HashVer</span>&#123;</span><br><span class="line">    <span class="type">char</span> sign[<span class="number">0x10</span>]; <span class="comment">// HashVer1.4</span></span><br><span class="line">    DWORD table_size;  <span class="comment">// 100h 可能是表的大小???</span></span><br><span class="line">    DWORD file_cnt; <span class="comment">// 12h</span></span><br><span class="line">    DWORD unk; <span class="comment">// 48h</span></span><br><span class="line">    DWORD dataSize; <span class="comment">// 249h</span></span><br><span class="line">    DWORD signal; <span class="comment">// 标志位 1 则decrypt2</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="type">char</span> data[<span class="number">0x249</span>]; <span class="comment">// 加密的数据</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Decrypt2DataHead"><a href="#Decrypt2DataHead" class="headerlink" title="Decrypt2DataHead"></a>Decrypt2DataHead</h2><p>地址: 028D8120<br>结构:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Decrypt2DataHead</span>&#123;</span><br><span class="line">    DWORD sign; <span class="comment">//FF435031</span></span><br><span class="line">    DWORD isWord; <span class="comment">// 1:unsigned __int16</span></span><br><span class="line">    DWORD size; <span class="comment">// 922h</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="FileEntry"><a href="#FileEntry" class="headerlink" title="FileEntry"></a>FileEntry</h2><p>结构:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">FileEntry</span>&#123;</span><br><span class="line">    QWORD offset; <span class="comment">// DWORD2:DWORD1</span></span><br><span class="line">    DWORD size;</span><br><span class="line">    DWORD decrypted_size; <span class="comment">// 解密后的size</span></span><br><span class="line">    DWORD isCompressed; <span class="comment">// 0/1 标志位</span></span><br><span class="line">    DWORD unk;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="近月2-流程梳理"><a href="#近月2-流程梳理" class="headerlink" title="近月2 流程梳理"></a>近月2 流程梳理</h1><h2 id="FilePack"><a href="#FilePack" class="headerlink" title="FilePack"></a>FilePack</h2><p><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image.png" alt="img"><br>注意把 setfilepointer打开!!! 这里设置文件指针是设置源文件的 也就是data0.pack的地址<br>看日志</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">设置文件指针  句柄:370 偏移量:00  基准:2</span><br><span class="line">设置文件指针  句柄:370 偏移量:00  基准:0</span><br><span class="line">设置文件指针  句柄:370 偏移量:024D0DE0  基准:0</span><br><span class="line">读取文件:  句柄:370 缓冲:19FAF7 字节数:1C</span><br></pre></td></tr></table></figure>

<p>读取的就是文件最末的0x1C字节数据<br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-1.png" alt="img"><br>结合前面走弯路逆错文件的经验 可以分析出大致结构<br>开头的是<code>FilePack</code>的签名 后面<code>12 00 00 00</code> 应该是size之类的<br>然后的 <code>35 01 4D 02</code> 跟右边的offset很像 所以应该是某个入口点的指针 最后一个DWORD的0不知道什么含义</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">FilePack</span>&#123;</span><br><span class="line">    <span class="type">char</span> sign[<span class="number">0x10</span>]; <span class="comment">// version</span></span><br><span class="line">    DWORD size; <span class="comment">// ? unsure of which</span></span><br><span class="line">    DWORD EntryAddress; <span class="comment">// probably</span></span><br><span class="line">    DOWRD unknown; <span class="comment">// 0?</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回x32dbg 跳出这个函数 把上下的函数借助IDA写上标签便于识别<br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-2.png" alt="img"><br>注意到取了前0x10 来验签</p>
<h3 id="文件读取初始化"><a href="#文件读取初始化" class="headerlink" title="文件读取初始化"></a>文件读取初始化</h3><p>步进文件读取初始化的函数里<br>IDA可以很清楚的看清函数结构 关注SetPoint的日志<br><code>设置文件指针  句柄:370 偏移量:024D09BC  基准:0</code><br>然后后面Read 继续看日志<br><code>读取文件:  句柄:370 缓冲:19F684 字节数:440</code><br>跟踪出来发现确实从data0.pack <code>024D09BC</code>处读取了440(0x124)字节数据<br>其实往上翻翻可以发现这个在一个开头为 <code>HashVer1.4</code>的结构体的最末</p>
<p>Read过后做了一个比较奇怪的check: 检查检查结尾后的第一个byte是否<code>&gt;=0 &lt;=8</code> 若否就置为0<br>然后取eax:起始位置+24h 复制了0x100的数据到<code>[ecx+ebx+0x54]</code>的内存<br>后面就开始有计算hash和decrypt的了 结合IDA和动调<br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-3.png" alt="img"><br>然后就是取0x20字节转unicode后与 <code>8hr48uky,8ugi8ewra4g8d5vbf5hb5s6</code>对比<br>其中关于Hash的计算以及decrypt的算法IDA一目了然 不需要过多深入的分析 解密时IDA开一个AutoComment照着XMM指令集写即可<br>可能其中会涉及到一些间接调用之类的 动调找也比较好找</p>
<p>这里发现只需要进入decrypt动调一些值即可<br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-4.png" alt="img"><br>这里一个是长度 另一个就是先前计算得到的hash值 <code>0658D1A0</code><br>其实和先前的hash有一点点小区别? 动调得到的hash函数返回eax是 <code>D658D1A0</code><br>这样初始的 <code>*(_DWORD *)(a1 + 8)</code>和 <code>*(_DWORD *)(a1 - 4)</code>就得到了<br>还有一个 <code>*(__m64 **)(a1 - 8)</code> 动调发现是一个指向先前读取440字节数据的指针 也就是我们的解密源数据<br>然后取了0x20来解密<br>解出来的就是 <code>8hrxxx</code> 然后转unicode 验签</p>
<p>然后进行了一大堆赋值操作 注意细看<br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-5.png" alt="img"><br>结合cdq我们可以知道 <code>FilePack</code>里面的Entry应该是QWORD类型 而且只有三个成员<br>所以可以写出<code>FilePack</code>结构</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">FilePack</span>&#123;</span><br><span class="line">    <span class="type">char</span> sign[<span class="number">0x10</span>];</span><br><span class="line">    DWORD size;</span><br><span class="line">    QWORD EntryPoint;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后又开始设置文件指针<br><code>设置文件指针  句柄:35C 偏移量:024D072F  基准:0</code><br>指向的正是data0中的HashVer结构体<br>然后调用CopyFrom 接着又构造了一个类<br>然后看日志发现 <code>读取文件:  句柄:35C 缓冲:296C5B0 字节数:28D</code><br>查看对应内存<br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-6.png" alt="img"><br>所以前面从data0复制HashVer到内存中</p>
<p>现在来关注之前取出的440字节的数据 不妨称作 HashData 因为Hash解密出一个签名<br>然后有个很关键的是签名后的第一个DWORD: 028D 是后面计算地址的offset</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">HashData</span>&#123;</span><br><span class="line">    <span class="type">char</span> sign[<span class="number">0x20</span>]; <span class="comment">//8hr...</span></span><br><span class="line">    DWORD offset; <span class="comment">// 028D</span></span><br><span class="line">    <span class="type">char</span> data[<span class="number">0x100</span>]; <span class="comment">//256字节数据</span></span><br><span class="line">    DWORD unk; <span class="comment">//先前检验data后一个字节 &lt;0||&gt;8就设置为0</span></span><br><span class="line">    <span class="type">char</span> Blank[<span class="number">0x2F8</span>] <span class="comment">//空字节占位</span></span><br><span class="line">    FilePack filepack; <span class="comment">// FilePack结构体</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关注一下怎么通过 HashData找到HashVer的<br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-7.png" alt="img"><br>可以看到先是取出offset 028D 然后用HashData的地址去索引HashVer</p>
<p>接下来关注对HashVer结构体作了什么操作<br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-8.png" alt="img"><br>前面构造的类的指针是指向<code>HashVer</code>开头 所以可以确定下面是对这个结构体的处理<br><code>sub_4EB8C0</code>函数在IDA能大致看出功能<br>先验签 然后解密 再Copy回内存<br>验签:<br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-9.png" alt="img"><br>对HashVer的数据读取:<br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-10.png" alt="img"><br>然后用CopyFrom往类中写入数据<br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-11.png" alt="img"><br>发现这个函数还是解出 <code>8hx...</code>的那个 将其重命名为decrypt<br>接下来出现了第二个解密函数<br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-12.png" alt="img"></p>
<p>再看0296C5B0处的HashVer结构体 一些值的作用就清晰了<br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-13.png" alt="img"><br>前面调用过GetSize 返回的是 249h 说明hashver后第四个DWORD就是size<br>前面又分析过了第五个DWORD是标志位 决定是否调用decrypt2</p>
<p>所以解密流程就是先对hashver的数据用decrypt解密 若标志位为1 继续进行decrypt2解密<br>decrypt2结合IDA+x32dbg动调数据来理解</p>
<p>一堆ReadFile 但是并没有调用API 所以需要手动进入找到读的那片内存<br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-14.png" alt="img"><br>找几个寄存器试试就找到这块<br>接下来的Read都是在这片内存 028D8120<br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-15.png" alt="img"><br>第一个DWORD肯定是验证 第二个多半是标志位 第三个是size<br>这里ReadFile读取的值是存在ecx寄存器里的<br>后面对size进行了一个检查 结合IDA: <code>v17&lt;-[ebp-10h]</code> 也可以确定前面922h就是size</p>
<p>后面有一些间接寻址操作 结合动调来看<br>从004E5722开始<br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-16.png" alt="img"><br>这里动调一下会发现有size 有待解密数据的起始地址 又结合IDA知道这就是 end指针<br><code>idr617538_Move(v10, v11, 256);</code> 这句就是把前面建的[0~255]的表复制一份 原表是v10<br>接下来IDA反编译都比较清晰<br>注意到第85行<code>if ( (v12 &amp; 1) == 1 ) </code> 这里往前翻就知道是读取的第二个DWORD 也就是我们猜测的标志位1<br>其实这里就是一个数据类型格式的check<br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-17.png" alt="img"><br>根据不同数据格式来移指针<br>标志位为1代表是WORD类型</p>
<p>最后注意下虽然看似只有一次if但是后面有个 <code>goto label36</code> 所以是个循环<br>这个循环中套的一个 栈+找index的解密<br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-18.png" alt="img"><br>可以通过 <code>v15 &lt;- v15 = (_BYTE *)*((_DWORD *)v16 + 1);</code> 知道v15就是指向以v16起始的空间<br>最后返回解密后的类指针</p>
<p>为了统一 对这部分解密的数据结构装一个结构体 命名为 Decrypt2DataHead(跟教程一样)<br>因为这是decrypt2之前的头部结构 很容易写出来<br>Decrypt2DataHead:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Decrypt2DataHead</span>&#123;</span><br><span class="line">    DWORD sign; <span class="comment">//FF435031</span></span><br><span class="line">    DWORD isWord; <span class="comment">// 1:unsigned __int16</span></span><br><span class="line">    DWORD size; <span class="comment">// 922h</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>找到解密数据的内存 028DA150 然后跑完decrypt2<br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-19.png" alt="img"><br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-20.png" alt="img"></p>
<p>解出来的都是文件名 所以HashVer的数据存的应该是这个pack里打包的文件名<br>可以数下有多少个文件 18个 12h 刚好对应HashVer的第二个Dword 同时也跟FilePack里的size对应上了<br>HashVer的结构:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">HashVer</span>&#123;</span><br><span class="line">    <span class="type">char</span> sign[<span class="number">0x10</span>]; <span class="comment">// HashVer1.4</span></span><br><span class="line">    DWORD table_size;  <span class="comment">// 100h 可能是表的大小???</span></span><br><span class="line">    DWORD file_cnt; <span class="comment">// 12h</span></span><br><span class="line">    DWORD unk; <span class="comment">// 48h</span></span><br><span class="line">    DWORD dataSize; <span class="comment">// 249h</span></span><br><span class="line">    DWORD signal; <span class="comment">// 标志位 1 则decrypt2</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="type">char</span> data[<span class="number">0x249</span>]; <span class="comment">// 加密的数据</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跳出函数 回到 4EDA1B<br>现在我们还在文件读取初始化函数中 刚刚结束了验签+解密数据等操作<br>然后新设置了文件指针 <code>设置文件指针  句柄:350 偏移量:024D0135  基准:0</code><br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-21.png" alt="img"><br>发现就是 <code>FilePack</code>的几个数据 size和EnrtyPoint<br>然后进行了一个 12次(size次)的循环 那么应该就是分别解密每个文件的数据了<br>IDA可以很直观的看出来:<br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-22.png" alt="img"><br><code>sub_4E4C18</code>就是关键的解密函数<br>先IDA看个大概结构<br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-23.png" alt="img"><br>动调看一看间接调用即可<br>可以发现这部分指向了HashData<br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-24.png" alt="img"><br>注意到传入的第二个参数<code> *(_DWORD *)(*(_DWORD *)v1 + 80)</code> 也就是edx 指向的是之前算出的Hash值 <code>0658D1A0</code><br>然后又ReadFile <code>读取文件:  句柄:364 缓冲:19F642 字节数:2</code><br>读了 <code>00 24</code><br>hashdata前面有一堆 发现是一些版权声明的日文<br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-25.png" alt="img"><br>然后又有ReadFile <code>读取文件:  句柄:364 缓冲:2981650 字节数:48</code><br>读的字节数是2*v4 v4的初始值是24h<br>这里的48和HashVer的那个unk的值可能有关联<br>然后就是解密了 IDA很明晰<br>这里v15取的应该是解密数据存放内存的指针(修改了数据格式 unicode转了一下 WORD类型)<br>do-while循环了24h次<br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-26.png" alt="img"><br>解密完后回到之前的循环继续下个文件的解密<br>日志打印如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">读取文件:  句柄:364 缓冲:19F642 字节数:2</span><br><span class="line">断点已设置在 004E4CB8 ！</span><br><span class="line">INT3 断点于 月に寄りそう乙女の作法2.2.004E4CB8 (004E4CB8)!</span><br><span class="line">读取文件:  句柄:364 缓冲:2981650 字节数:48</span><br><span class="line">读取文件:  句柄:364 缓冲:28D6118 字节数:1C</span><br><span class="line">INT3 断点于 月に寄りそう乙女の作法2.2.004EDA9A (004EDA9A)!</span><br><span class="line">读取文件:  句柄:364 缓冲:19F642 字节数:2</span><br><span class="line">读取文件:  句柄:364 缓冲:29AFDC8 字节数:12</span><br><span class="line">读取文件:  句柄:364 缓冲:28D6134 字节数:1C</span><br><span class="line">INT3 断点于 月に寄りそう乙女の作法2.2.004EDA9A (004EDA9A)!</span><br><span class="line">读取文件:  句柄:364 缓冲:19F642 字节数:2</span><br><span class="line">读取文件:  句柄:364 缓冲:29CB858 字节数:18</span><br><span class="line">读取文件:  句柄:364 缓冲:28D6150 字节数:1C</span><br><span class="line">INT3 断点于 月に寄りそう乙女の作法2.2.004EDA9A (004EDA9A)!</span><br><span class="line">读取文件:  句柄:364 缓冲:19F642 字节数:2</span><br><span class="line">读取文件:  句柄:364 缓冲:299F590 字节数:2C</span><br><span class="line">读取文件:  句柄:364 缓冲:28D616C 字节数:1C</span><br><span class="line">INT3 断点于 月に寄りそう乙女の作法2.2.004EDA9A (004EDA9A)!</span><br><span class="line">读取文件:  句柄:364 缓冲:19F642 字节数:2</span><br><span class="line">读取文件:  句柄:364 缓冲:299F590 字节数:26</span><br><span class="line">读取文件:  句柄:364 缓冲:28D6188 字节数:1C</span><br><span class="line">INT3 断点于 月に寄りそう乙女の作法2.2.004EDA9A (004EDA9A)!</span><br><span class="line">读取文件:  句柄:364 缓冲:19F642 字节数:2</span><br><span class="line">读取文件:  句柄:364 缓冲:299F590 字节数:28</span><br><span class="line">读取文件:  句柄:364 缓冲:28D61A4 字节数:1C</span><br><span class="line">INT3 断点于 月に寄りそう乙女の作法2.2.004EDA9A (004EDA9A)!</span><br><span class="line">读取文件:  句柄:364 缓冲:19F642 字节数:2</span><br><span class="line">读取文件:  句柄:364 缓冲:29B4D58 字节数:30</span><br><span class="line">读取文件:  句柄:364 缓冲:28D61C0 字节数:1C</span><br><span class="line">INT3 断点于 月に寄りそう乙女の作法2.2.004EDA9A (004EDA9A)!</span><br><span class="line">读取文件:  句柄:364 缓冲:19F642 字节数:2</span><br><span class="line">读取文件:  句柄:364 缓冲:29B4D58 字节数:30</span><br><span class="line">读取文件:  句柄:364 缓冲:28D61DC 字节数:1C</span><br><span class="line">INT3 断点于 月に寄りそう乙女の作法2.2.004EDA9A (004EDA9A)!</span><br><span class="line">读取文件:  句柄:364 缓冲:19F642 字节数:2</span><br><span class="line">读取文件:  句柄:364 缓冲:29BBE28 字节数:36</span><br><span class="line">读取文件:  句柄:364 缓冲:28D61F8 字节数:1C</span><br><span class="line">INT3 断点于 月に寄りそう乙女の作法2.2.004EDA9A (004EDA9A)!</span><br><span class="line">读取文件:  句柄:364 缓冲:19F642 字节数:2</span><br><span class="line">读取文件:  句柄:364 缓冲:29BBE28 字节数:36</span><br><span class="line">读取文件:  句柄:364 缓冲:28D6214 字节数:1C</span><br><span class="line">INT3 断点于 月に寄りそう乙女の作法2.2.004EDA9A (004EDA9A)!</span><br><span class="line">读取文件:  句柄:364 缓冲:19F642 字节数:2</span><br><span class="line">读取文件:  句柄:364 缓冲:29B4D58 字节数:34</span><br><span class="line">读取文件:  句柄:364 缓冲:28D6230 字节数:1C</span><br><span class="line">INT3 断点于 月に寄りそう乙女の作法2.2.004EDA9A (004EDA9A)!</span><br><span class="line">读取文件:  句柄:364 缓冲:19F642 字节数:2</span><br><span class="line">读取文件:  句柄:364 缓冲:29B4D58 字节数:34</span><br><span class="line">读取文件:  句柄:364 缓冲:28D624C 字节数:1C</span><br><span class="line">INT3 断点于 月に寄りそう乙女の作法2.2.004EDA9A (004EDA9A)!</span><br><span class="line">读取文件:  句柄:364 缓冲:19F642 字节数:2</span><br><span class="line">读取文件:  句柄:364 缓冲:29BBF48 字节数:38</span><br><span class="line">读取文件:  句柄:364 缓冲:28D6268 字节数:1C</span><br><span class="line">INT3 断点于 月に寄りそう乙女の作法2.2.004EDA9A (004EDA9A)!</span><br><span class="line">读取文件:  句柄:364 缓冲:19F642 字节数:2</span><br><span class="line">读取文件:  句柄:364 缓冲:297A038 字节数:52</span><br><span class="line">读取文件:  句柄:364 缓冲:28D6284 字节数:1C</span><br><span class="line">INT3 断点于 月に寄りそう乙女の作法2.2.004EDA9A (004EDA9A)!</span><br><span class="line">读取文件:  句柄:364 缓冲:19F642 字节数:2</span><br><span class="line">读取文件:  句柄:364 缓冲:28CBDD0 字节数:56</span><br><span class="line">读取文件:  句柄:364 缓冲:28D62A0 字节数:1C</span><br><span class="line">INT3 断点于 月に寄りそう乙女の作法2.2.004EDA9A (004EDA9A)!</span><br><span class="line">读取文件:  句柄:364 缓冲:19F642 字节数:2</span><br><span class="line">读取文件:  句柄:364 缓冲:297A038 字节数:54</span><br><span class="line">读取文件:  句柄:364 缓冲:28D62BC 字节数:1C</span><br><span class="line">INT3 断点于 月に寄りそう乙女の作法2.2.004EDA9A (004EDA9A)!</span><br><span class="line">读取文件:  句柄:364 缓冲:19F642 字节数:2</span><br><span class="line">读取文件:  句柄:364 缓冲:28CBEA0 字节数:56</span><br><span class="line">读取文件:  句柄:364 缓冲:28D62D8 字节数:1C</span><br><span class="line">INT3 断点于 月に寄りそう乙女の作法2.2.004EDA9A (004EDA9A)!</span><br><span class="line">读取文件:  句柄:364 缓冲:19F642 字节数:2</span><br><span class="line">读取文件:  句柄:364 缓冲:29B4D58 字节数:34</span><br><span class="line">读取文件:  句柄:364 缓冲:28D62F4 字节数:1C</span><br></pre></td></tr></table></figure>

<p>然后来分析这些读取的究竟是些什么数据<br>看都是固定长度1C的数据 多分析几组<br><code>00 00 00 00 00 00 00 00 23 10 00 00 23 10 00 00 00 00 00 00 01 00 00 00 12 40 63 EB</code><br><code>23 10 00 00 00 00 00 00 57 02 00 00 F6 06 00 00 01 00 00 00 01 00 00 00 23 F2 E4 E4</code><br><code>7A 12 00 00 00 00 00 00 64 03 00 00 64 12 00 00 01 00 00 00 01 00 00 00 BC 0C 7A ED</code><br><code>DE 15 00 00 00 00 00 00 1C 12 00 00 1C 12 00 00 00 00 00 00 01 00 00 00 0C E4 5E FF</code><br>…<br><code>0C 4F 00 00 00 00 00 00 A5 0A 00 00 A5 0A 00 00 00 00 00 00 01 00 00 00 EA C6 DC F9</code></p>
<p>由日志可以看出1C这组地址是连续的 很像一个结构体数组<br>由第一二组 &#x3D;&gt; 00 00 00 00 + 23 10 00 00 &#x3D; 23 10 00 00<br>大致能确定前两个DWORD组成一个QWORD(结合前面的经验)代表地址 然后第三个DWORD代表size(相邻地址的间隔)<br>然后发现一个很有趣的点 观察第四个和第五个DWORD<br>从第五个DWORD入手 当其为0的时候 发现第三个DWORD的size和第四个DWORD的值一样<br>而为1的时候 第四个比第三个大<br>由于这是在FilePack的文件读取初始化中 且我们以及解密了文件名 那么现在解的就是文件本体了<br>可以推断第五个DWORD是标志位 代表大小是否改变 那么第四个DWORD就应该是解密后的size了  至于最后一个DWORD完全看不出来 可能是CRC校验之类的<br>由于这个结构体的功能是 索引地址+提供解密所需的标志参数 将其命名为FileEntry(还是取一样的)<br>结构如下:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">FileEntry</span>&#123;</span><br><span class="line">    QWORD offset; <span class="comment">// DWORD2:DWORD1</span></span><br><span class="line">    DWORD size;</span><br><span class="line">    DWORD decrypted_size; <span class="comment">// 解密后的size</span></span><br><span class="line">    DWORD isCompressed; <span class="comment">// 0/1 标志位</span></span><br><span class="line">    DWORD unk1; <span class="comment">// all_the_same : 1</span></span><br><span class="line">    DWORD unk2; <span class="comment">// maybe hash/CRC</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="文件解密"><a href="#文件解密" class="headerlink" title="文件解密"></a>文件解密</h3><p>然后要等所有文件的文件名都解完过后才进入文件解密<br>前面的流程大致是把每个datax.pack的文件名都解密了 然后都读取了FileEntry<br>结束后日志发现有个 <code>读取文件:  句柄:360 缓冲:3CED440 字节数:1023</code><br>关键的解密函数在sub_4ED454 但找不到是怎么进到这个函数的…<br>IDA看大致结构:<br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-27.png" alt="img"><br>根据传入的参数来选择不同分支<br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-28.png" alt="img"><br>进入decrypt3后又有个分支<br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-29.png" alt="img"><br>但其实IDA看一模一样… 只是写法有一点差异 实现功能完全相同</p>
<p>近月2所有都是decrypt3 从前面分析的<code>FileEntry</code>结构体可知<br>IDA看<br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-30.png" alt="img"><br>由前面的经验知道<code>sub_4ECE7C(a1);</code>就是算出一个hash供后面作为key解密<br>进入hash函数<br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-31.png" alt="img"></p>
<p>先是用 “pack_keyfile_kfueheish15538fa9or.key”对两个key又做了加密<br>然后进入sub_4ECE40算HASH<br>这里的传参要仔细动调<br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-32.png" alt="img"><br>而另一个调一调发现是前面传入的1023 也就是读取文件的size<br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-33.png" alt="img"><br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-34.png" alt="img"></p>
<p>XMM指令集开个自动注释就都能弄懂 <code>_m_pslldi</code>是DWORD逻辑左移<br>然后动调看看哪个值指向hash[]<br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-35.png" alt="img"><br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-36.png" alt="img"></p>
<p>到此 近月2的文件解密已经告一段落了<br>近月2都用的decrypt3 而 万华镜用的都是decrypt4</p>
<p>总流程:<br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/flow.png" alt="img"></p>
<h1 id="万华镜5"><a href="#万华镜5" class="headerlink" title="万华镜5"></a>万华镜5</h1><p>经过前面近月2的逆向 对qlie引擎有了一定的了解<br>万华镜5和近月2最大的不同就在于前者采用的是decrypt4</p>
<p>wtm谢谢你… 伟大的汉化组汉化完加了个壳…<br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-37.png" alt="img"></p>
<p>先看看万华镜4 感觉逻辑应该差不了太多<br>第一个难点 如何定位到decrypt4的地方?<br>当然可以再跟着近月2的步骤调试一遍<br>但有个更好用的方法:<br>我们知道这两款游戏的引擎是一样的 所以基本特征肯定是相同的<br>我们复制近月2的decrypt3附近的字节码<br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-38.png" alt="img"><br>然后在x32dbg的内存布局里搜索匹配特征<br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-39.png" alt="img"><br>嗖的一下 就搜到了~<br>成功定位<br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-40.png" alt="img"></p>
<p>很离谱的是为什么万华镜4大部分都是decrypt3啊…<br>终于断到decrypt4过后就可以开始逆了~<br>将近月2的decrypt3和镜的decrypt4对比着看很容易看出区别</p>
<h2 id="decrypt4"><a href="#decrypt4" class="headerlink" title="decrypt4"></a>decrypt4</h2><p>开始分析<br>进入后跟decrypt3一样 也有两个分支 但是都是大同小异 功能完全一样<br>而且对比近月2和镜4发现decrypt4函数也一模一样<br>所有关键参数甚至连变量命名都一样 所以可以放心逆镜4的decrypt4</p>
<p>IDA大致对比一下dec3和dec4<br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-41.png" alt="img"><br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-42.png" alt="img"></p>
<p>首先是hash函数实现不同 然后就是dec4多了一个hash表&#x2F;key表 用的双表加密而非3的单表加密</p>
<p>但hash函数也只是改了些加密常量而已 具体算法都没变</p>
<p>接下来关注那个多出来的表<br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-43.png" alt="img"><br>确实有另一个table在 总长度为0x400 bytes<br>很巧的是教程用镜5 不同的文件调用decrypt4时的table长度是一样的 内容不一样<br>那就很自然想知道这个table或者key数组在哪里被怎么算出来的?</p>
<h3 id="回溯找key"><a href="#回溯找key" class="headerlink" title="回溯找key[]"></a>回溯找<code>key[]</code></h3><p>教程教了一个很棒的方法 用强大的CheatEngine来搜索这个key数组<br>搜索选项调成搜索<code>字节数组</code><br>就搜索开头的几个DWORD<br><code>48 BA EC 20 08 60 BB 96 6E 12 88 8E D7 5B 2F 35 02 5F DA D7 11 9A 9F B7 03 6C 7D CA E3 FE 3F 07</code><br>发现已经可数了<br>扫镜4:<br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-45.png" alt="img"><br>接下来就是逐步往前回溯了 去找在哪个调用点的时候刚好算出了key<br>还想着看能不能通过IDA的立即数搜索缩小一下范围 发现0x400出现的太多 还是老老实实看交叉引用吧…</p>
<p>往上回溯到进入调用dec3,4的函数 断在dec3发现已经算出key了…<br>跟之前猜测有误 说明这个key也许是固定的?<br>继续往上回溯<br>发现有两个可能 下断点标记一下 发现在第二个进入的<br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-46.png" alt="img"></p>
<p>从<code>sub_4E966C</code>再往上回溯<br>下断点动调&lt;- <code>sub_4E9800</code><br>&lt;-<code>sub_4EA4B4</code> 还有key[]…<br>&lt;-<code>sub4EC5AC</code><br>再回溯就有很多分支了…<br>直接一键在所有分支设断点 发现断在一个比较奇怪的地址<br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-47.png" alt="img"><br>地址是6开头 不是用户区的4也不是系统区的7 而是引擎的代码?<br>来到了<code>sub_6DD224</code>函数<br>&lt;-<code>sub_6DD9B8</code><br>发现在这个开头的时候就没有key了!!!<br>!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!<br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-48.png" alt="img"><br>没多少了 慢慢排除<br>挨个if下断点CE来找<br>得到结论:<br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-49.png" alt="img"><br>就是在sub_4EC10C里面的do-while来算的key<br>但4这里面看起来完全不像是在计算key的啊…<br>采取一步一段然后CE查的方法 定位到这里<br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-50.png" alt="img"><br>发现貌似引用了data0.hash这种<br><img src="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/images/image-51.png" alt="img"><br>这就尴尬了…<br>在想是不是4和5的区别???<br>…服了…<br>也就是5之前的镜是用前面文件解密得到的datax.hash来计算???或是直接copy过来???<br>后续代码编写后运行也发现确实有较大区别<br>先还是按照镜5的代码来写<br>当然逆向的基本流程已经全部实操过了 等找到镜5的无壳版本再找一遍key的生成函数</p>
<h1 id="解密代码"><a href="#解密代码" class="headerlink" title="解密代码"></a>解密代码</h1><p>到了最后的环节了 根据前面得到的所有信息来编写镜5的解包程序</p>
<p>自己尝试写到decrypt3_hash 后面是在写不动了… 也不是很想再开x32dbg去找对应offset了 再加上没有镜5也不好找decrypt4_hash<br>在佬的源代码上做了些修改 加了一些自己的理解 希望有朝一日能够独立写出这样的代码 把万华镜4类似的独立解包吧~</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;mmintrin.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> QWORD unsigned __int64</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __PAIR64__(high, low)   (((QWORD) (high) &lt;&lt; 32) | (DWORD)(low))</span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">FilePackVer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> sign[<span class="number">0x10</span>];</span><br><span class="line">    DWORD filecount;</span><br><span class="line">    <span class="type">int</span> entry_low;</span><br><span class="line">    <span class="type">int</span> entry_high;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">HashData</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> sign[<span class="number">0x20</span>];</span><br><span class="line">    DWORD HashVerSize;</span><br><span class="line">    <span class="type">char</span> data[<span class="number">0x100</span>];</span><br><span class="line">    DWORD Unkown;</span><br><span class="line">    <span class="type">char</span> Blank[<span class="number">0x2F8</span>];</span><br><span class="line">    FilePackVer fpacker;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Dencrypt2DataHead</span></span><br><span class="line">&#123;</span><br><span class="line">    DWORD sign;</span><br><span class="line">    DWORD isWordType;</span><br><span class="line">    DWORD size;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Dencrypt2DataOutput</span></span><br><span class="line">&#123;</span><br><span class="line">    BYTE* data;</span><br><span class="line">    DWORD len;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">FileEntry</span></span><br><span class="line">&#123;</span><br><span class="line">    DWORD offset_low;</span><br><span class="line">    DWORD offset_hight;</span><br><span class="line">    DWORD size;</span><br><span class="line">    DWORD dencrypted_size;</span><br><span class="line">    DWORD isCompressed;</span><br><span class="line">    DWORD EncryptType;</span><br><span class="line">    DWORD hash;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">DWORD <span class="title">Tohash</span><span class="params">(<span class="type">void</span>* data, <span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (len &lt; <span class="number">8</span>)<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//准备工作</span></span><br><span class="line">    __m64 mm0 = _mm_cvtsi32_si64(<span class="number">0</span>);</span><br><span class="line">    __m64 mm1;</span><br><span class="line">    __m64 mm2 = _mm_cvtsi32_si64(<span class="number">0</span>);</span><br><span class="line">    DWORD key = <span class="number">0xA35793A7</span>;</span><br><span class="line">    __m64 mm3 = _mm_cvtsi32_si64(key);</span><br><span class="line">     mm3 = _m_punpckldq(mm3, mm3);</span><br><span class="line">     __m64* pdata=(__m64*)data;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; (len &gt;&gt; <span class="number">3</span>); i++)</span><br><span class="line">    &#123;</span><br><span class="line">        mm1 = *pdata;</span><br><span class="line">        pdata++;</span><br><span class="line">        mm2 = _m_paddw(mm2, mm3);</span><br><span class="line">        mm1 = _m_pxor(mm1, mm2);</span><br><span class="line">        mm0 = _m_paddw(mm0, mm1);</span><br><span class="line">        mm1 = mm0;</span><br><span class="line">        mm0 = _m_pslldi(mm0, <span class="number">3</span>);</span><br><span class="line">        mm1 = _m_psrldi(mm1, <span class="number">0x1D</span>);</span><br><span class="line">        mm0 = _m_por(mm1, mm0);</span><br><span class="line">    &#125;</span><br><span class="line">    mm1 = _m_psrlqi(mm0, <span class="number">32</span>);</span><br><span class="line">    DWORD result = _mm_cvtsi64_si32(_m_pmaddwd(mm0, mm1));</span><br><span class="line">    _m_empty();</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">dencrypt</span><span class="params">(<span class="type">void</span>* data,<span class="type">unsigned</span> <span class="type">int</span> len, DWORD hash)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (len &gt;&gt; <span class="number">3</span> == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    DWORD key1 = <span class="number">0xA73C5F9D</span>;</span><br><span class="line">    DWORD key2 = <span class="number">0xCE24F523</span>;</span><br><span class="line">    DWORD key3 = (len + hash)^ <span class="number">0xFEC9753E</span>;</span><br><span class="line">    __m64 mm7 = _mm_cvtsi32_si64(key1);</span><br><span class="line">    mm7 = _m_punpckldq(mm7, mm7);</span><br><span class="line">    __m64 mm6 = _mm_cvtsi32_si64(key2);</span><br><span class="line">    mm6 = _m_punpckldq(mm6, mm6);</span><br><span class="line">    __m64 mm5 = _mm_cvtsi32_si64(key3);</span><br><span class="line">    mm5 = _m_punpckldq(mm5, mm5);</span><br><span class="line">    __m64* datapos = (__m64*)data;</span><br><span class="line">    __m64 mm0;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; len &gt;&gt; <span class="number">3</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        mm7 = _m_paddd(mm7, mm6);</span><br><span class="line">        mm7 = _m_pxor(mm7, mm5);</span><br><span class="line">        mm0 = *datapos;</span><br><span class="line">        mm0 = _m_pxor(mm0, mm7);</span><br><span class="line">        mm5 = mm0;</span><br><span class="line">        *datapos = mm0;</span><br><span class="line">        datapos++;</span><br><span class="line">    &#125;</span><br><span class="line">    _m_empty();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">Dencrypt2DataOutput* <span class="title">dencrypt2</span><span class="params">(<span class="type">void</span>* data, <span class="type">unsigned</span> <span class="type">int</span> len,<span class="type">unsigned</span> <span class="type">int</span> dencrypted_len, DWORD hash)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> old_table[<span class="number">0x100</span>],new_table[<span class="number">0x100</span>],other[<span class="number">0x100</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">0x100</span>; i++)</span><br><span class="line">        old_table[i] = i;</span><br><span class="line">    Dencrypt2DataHead* head = (Dencrypt2DataHead*)data;</span><br><span class="line">    <span class="keyword">if</span> (head-&gt;sign != <span class="number">0xFF435031</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Errod! 0xFF435031&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (head-&gt;size&gt; <span class="number">0x20000000</span>u)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Error! 0x20000000&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    Dencrypt2DataOutput* Output = <span class="keyword">new</span> <span class="built_in">Dencrypt2DataOutput</span>();</span><br><span class="line">    Output-&gt;len = dencrypted_len;</span><br><span class="line">    Output-&gt;data = <span class="keyword">new</span> BYTE[dencrypted_len + <span class="number">1</span>];</span><br><span class="line">    BYTE* outputbuff = Output-&gt;data;</span><br><span class="line">    BYTE* datapos = (BYTE*)data + <span class="built_in">sizeof</span>(Dencrypt2DataHead);</span><br><span class="line">    BYTE* data_start = datapos;</span><br><span class="line">    BYTE* data_end = (BYTE*)data + len;</span><br><span class="line">    BYTE chr;</span><br><span class="line">    <span class="type">int</span> t_pos;</span><br><span class="line">    <span class="type">int</span> size;</span><br><span class="line">    <span class="keyword">while</span> (data_start &lt; data_end)</span><br><span class="line">    &#123;</span><br><span class="line">        chr = *data_start;</span><br><span class="line">        datapos = data_start + <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">memcpy</span>(new_table, old_table, <span class="number">0x100</span>);</span><br><span class="line">        t_pos = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (chr &gt; <span class="number">0x7F</span>u)</span><br><span class="line">            &#123;</span><br><span class="line">                t_pos += chr - <span class="number">127</span>;</span><br><span class="line">                chr = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (t_pos &gt; <span class="number">0xFF</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; chr + <span class="number">1</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                new_table[t_pos] = *datapos++;</span><br><span class="line">                <span class="keyword">if</span> (t_pos != (<span class="type">unsigned</span> __int8)new_table[t_pos])</span><br><span class="line">                &#123;</span><br><span class="line">                    other[t_pos] = *datapos++;</span><br><span class="line">                &#125;</span><br><span class="line">                ++t_pos;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (t_pos &gt; <span class="number">0xFF</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            chr = *datapos++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ((head-&gt;isWordType &amp; <span class="number">1</span>) == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            size = *(WORD*)datapos;</span><br><span class="line">            data_start = (datapos + <span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            size = *(DWORD*)datapos;</span><br><span class="line">            data_start = (datapos + <span class="number">4</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        stack&lt;BYTE&gt; stack; <span class="comment">// unsigned char!</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            BYTE result;</span><br><span class="line">            <span class="keyword">if</span> (stack.<span class="built_in">size</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                result = stack.<span class="built_in">top</span>();</span><br><span class="line">                stack.<span class="built_in">pop</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (!size)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                size--;</span><br><span class="line">                result = *data_start;</span><br><span class="line">                data_start++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (result == (BYTE)new_table[result])</span><br><span class="line">            &#123;</span><br><span class="line">                *outputbuff = result;</span><br><span class="line">                outputbuff++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                stack.<span class="built_in">push</span>(other[result]);</span><br><span class="line">                stack.<span class="built_in">push</span>(new_table[result]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Output;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DencryptFileName</span><span class="params">(<span class="type">void</span>* data,<span class="type">int</span> character_count,DWORD hash)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> key = ((hash &gt;&gt; <span class="number">0x10</span>) &amp; <span class="number">0xFFFF</span>) ^ hash;</span><br><span class="line">    key = character_count ^ <span class="number">0x3E13</span> ^ key ^ (character_count * character_count);</span><br><span class="line">    DWORD ebx = key;</span><br><span class="line">    DWORD ecx;</span><br><span class="line">    WORD* datapos = (WORD*)data;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; character_count; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        ebx = ebx &lt;&lt; <span class="number">3</span>;</span><br><span class="line">        ecx = (ebx + i + key) &amp; <span class="number">0xFFFF</span>;</span><br><span class="line">        ebx = ecx;</span><br><span class="line">        *datapos = (*datapos ^ ebx) &amp; <span class="number">0xFFFF</span>;</span><br><span class="line">        datapos++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">DWORD* <span class="title">dencrypt3_hash</span><span class="params">(<span class="type">int</span> hashlen,<span class="type">int</span> datalen,<span class="type">void</span>* filename,<span class="type">int</span> character_count,DWORD Hash)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    DWORD key1 = <span class="number">0x85F532</span>;</span><br><span class="line">    DWORD key2 = <span class="number">0x33F641</span>; </span><br><span class="line">    WORD* character = (WORD*)filename; <span class="comment">// 指向文件名</span></span><br><span class="line">    <span class="type">size_t</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> v5 = character_count;</span><br><span class="line">    <span class="type">int</span> v6 = v5;</span><br><span class="line">    <span class="keyword">do</span>&#123;</span><br><span class="line">        key1 = key1 + (*character &lt;&lt; (i &amp; <span class="number">7</span>));</span><br><span class="line">        key2 ^= key1;</span><br><span class="line">        i++;</span><br><span class="line">        v6--;</span><br><span class="line">        character++;</span><br><span class="line">    &#125;<span class="keyword">while</span>(v6);</span><br><span class="line">    DWORD key3 = <span class="number">9</span>*((key2+(Hash^(<span class="number">7</span>*(datalen&amp;<span class="number">0xFFFFFF</span>)+datalen+key1+(key1^datalen^<span class="number">0x8F32DC</span>))))&amp;<span class="number">0xFFFFFF</span>);</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    QWORD a3 = key3;</span><br><span class="line">    DWORD* result = <span class="keyword">new</span> DWORD[hashlen];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; hashlen; i++)</span><br><span class="line">    &#123;</span><br><span class="line">		a3 = (<span class="number">0x8DF21431</span> * __PAIR64__(a3 ^ <span class="number">0x8DF21431</span>, a3 ^ <span class="number">0x8DF21431</span>)) &gt;&gt; <span class="number">32</span>;</span><br><span class="line">        *(result+i) = a3;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">dencrypt3</span><span class="params">(<span class="type">void</span>* data,<span class="type">int</span> len, <span class="type">void</span>* filekey)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//0x34相当于4字节数据+0xD</span></span><br><span class="line">    DWORD key1 = (*((DWORD*)filekey + <span class="number">0xD</span>) &amp; <span class="number">0xF</span>) &lt;&lt; <span class="number">3</span>;</span><br><span class="line">    BYTE* datapos = (BYTE*)data, * fkey = (BYTE*)filekey;</span><br><span class="line">    __m64 mm7 = *((__m64*)filekey + <span class="number">0x3</span>); <span class="comment">//这里0x3相当于BYTE的0x18</span></span><br><span class="line">    __m64 mm6, mm0, mm1;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; len &gt;&gt;<span class="number">3</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        mm6 = *(__m64*)(fkey + key1);</span><br><span class="line">        mm7 = _m_pxor(mm7, mm6);</span><br><span class="line">        mm7 = _m_paddd(mm7, mm6);</span><br><span class="line">        mm0 = *(__m64*)datapos;</span><br><span class="line">        mm0 = _m_pxor(mm0, mm7);</span><br><span class="line">        mm1 = mm0;</span><br><span class="line">        *(__m64*)datapos = mm0;</span><br><span class="line">        mm7 = _m_paddb(mm7, mm1);</span><br><span class="line">        mm7 = _m_pxor(mm7, mm1);</span><br><span class="line">        mm7 = _m_pslldi(mm7, <span class="number">0x1</span>);</span><br><span class="line">        mm7 = _m_paddw(mm7, mm1);</span><br><span class="line">        datapos += <span class="number">8</span>;</span><br><span class="line">        key1 = (key1 + <span class="number">8</span>) &amp; <span class="number">0x7F</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    _m_empty();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">BYTE* <span class="title">dencypt4_keyfilehash</span><span class="params">(<span class="type">void</span>* data,<span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span>* keyfilehash = <span class="keyword">new</span> <span class="type">int</span>[<span class="number">0x100</span>];</span><br><span class="line">    <span class="type">int</span>* keyfilehash_pos = keyfilehash;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">0x100</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">3</span> ==<span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            *keyfilehash_pos = (i + <span class="number">3u</span>) * (i + <span class="number">7u</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            *keyfilehash_pos = -(i + <span class="number">3u</span>) * (i + <span class="number">7u</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        keyfilehash_pos++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> key1 = *(BYTE*)((BYTE*)data + <span class="number">0x31</span>);</span><br><span class="line">    key1 = (key1 % <span class="number">0x49</span>) + <span class="number">0x80</span>;</span><br><span class="line">    <span class="type">int</span> key2 = *(BYTE*)((BYTE*)data + <span class="number">0x1E</span> + <span class="number">0x31</span>);</span><br><span class="line">    key2 = (key2 % <span class="number">7</span>) + <span class="number">7</span>;</span><br><span class="line">    BYTE* keyfilehash_pos_byte = (BYTE*)keyfilehash;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">0x400</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        key1 = (key1 + key2) % len;</span><br><span class="line">        *keyfilehash_pos_byte ^= *(BYTE*)((BYTE*)data + key1);</span><br><span class="line">        keyfilehash_pos_byte++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (BYTE*)keyfilehash;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">DWORD* <span class="title">dencrypt4_hash</span><span class="params">(<span class="type">int</span> hashlen, <span class="type">int</span> datalen, <span class="type">void</span>* filename, <span class="type">int</span> character_count, DWORD hash)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    DWORD key1 = <span class="number">0x86F7E2</span>; <span class="comment">//ebx</span></span><br><span class="line">    DWORD key2 = <span class="number">0x4437F1</span>; <span class="comment">//esi</span></span><br><span class="line">    WORD* character = (WORD*)filename;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; character_count; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        key1 = key1 + (*character &lt;&lt; (i &amp; <span class="number">7</span>));</span><br><span class="line">        key2 ^= key1;</span><br><span class="line">        character++;</span><br><span class="line">    &#125;</span><br><span class="line">    DWORD key3 = (datalen ^ key1 ^ <span class="number">0x56E213</span>) + key1 + datalen; <span class="comment">//eax</span></span><br><span class="line">    <span class="type">int</span> key4 = (datalen &amp; <span class="number">0xFFFFFF</span>) * <span class="number">0xD</span>; <span class="comment">//edx</span></span><br><span class="line">    key3 += key4;</span><br><span class="line">    key3 ^= hash;</span><br><span class="line">    key3 = ((key3 + key2) &amp; <span class="number">0xFFFFFF</span>) * <span class="number">0xD</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> rax = key3;</span><br><span class="line">    DWORD* result = <span class="keyword">new</span> DWORD[hashlen];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; hashlen; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        rax = (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)(rax ^ <span class="number">0x8A77F473</span>u) * (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)<span class="number">0x8A77F473</span>u;</span><br><span class="line">        rax = ((rax &amp; <span class="number">0xFFFFFFFF00000000</span>) &gt;&gt; <span class="number">32</span>) + (rax &amp; <span class="number">0xFFFFFFFF</span>);</span><br><span class="line">        rax = rax &amp; <span class="number">0xFFFFFFFF</span>;</span><br><span class="line">        result[i] = rax;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">dencrypt4</span><span class="params">(<span class="type">void</span>* data, <span class="type">int</span> len, <span class="type">void</span>* filekey,<span class="type">void</span>* keyfilehash)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	DWORD key1 = (*((BYTE*)filekey + <span class="number">0x20</span>) &amp; <span class="number">0xD</span>)*<span class="number">8</span>; <span class="comment">// v3 = 8 * (v12 &amp; 0xD); filekey作为esp?  v12:[esp+20h]</span></span><br><span class="line">    BYTE* datapos = (BYTE*)data, * fkey = (BYTE*)filekey,* keyfilekey = (BYTE*)keyfilehash; <span class="comment">// keyfilekey: 另一张hash表</span></span><br><span class="line">    __m64 mm7 = *((__m64*)filekey + <span class="number">0x3</span>); <span class="comment">//这里0x3相当于BYTE的0x18</span></span><br><span class="line">    __m64 mm6, mm0, mm1,mm5;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; len &gt;&gt; <span class="number">3</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        mm6 = *(__m64*)(fkey + ((key1 &amp; <span class="number">0xF</span>) &lt;&lt; <span class="number">3</span>));</span><br><span class="line">        mm5 = *(__m64*)(keyfilekey + ((key1 &amp; <span class="number">0x7F</span>) &lt;&lt; <span class="number">3</span>));</span><br><span class="line">        mm6 = _m_pxor(mm6, mm5);</span><br><span class="line">        mm7 = _m_pxor(mm7, mm6);</span><br><span class="line">        mm7 = _m_paddd(mm7, mm6);</span><br><span class="line">        mm0 = *(__m64*)datapos;</span><br><span class="line">        mm0 = _m_pxor(mm0, mm7);</span><br><span class="line">        mm1 = mm0;</span><br><span class="line">        *(__m64*)datapos = mm0;</span><br><span class="line">        mm7 = _m_paddb(mm7, mm1);</span><br><span class="line">        mm7 = _m_pxor(mm7, mm1);</span><br><span class="line">        mm7 = _m_pslldi(mm7, <span class="number">0x1</span>);</span><br><span class="line">        mm7 = _m_paddw(mm7, mm1);</span><br><span class="line">        datapos += <span class="number">8</span>;</span><br><span class="line">        key1 = (key1 + <span class="number">1</span>) &amp; <span class="number">0x7F</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    _m_empty();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">FILE* <span class="title">WideChar_CreateFile</span><span class="params">(<span class="type">const</span> <span class="type">wchar_t</span>* filename)</span> <span class="comment">// 建文件(包括dir)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">wchar_t</span>* pos = (<span class="type">wchar_t</span>*)filename;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        pos = <span class="built_in">wcschr</span>(pos, <span class="string">&#x27;\\&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (pos == <span class="literal">nullptr</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">wchar_t</span>* dir = <span class="keyword">new</span> <span class="type">wchar_t</span>[pos - filename + <span class="number">1</span>]();</span><br><span class="line">        <span class="built_in">wcsncpy</span>(dir, filename, pos - filename);</span><br><span class="line">        _wmkdir(dir);</span><br><span class="line">        pos++;</span><br><span class="line">        <span class="keyword">delete</span> dir;</span><br><span class="line">    &#125;</span><br><span class="line">    FILE* hfile = _wfopen(filename, <span class="string">L&quot;wb&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> hfile;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	ios::<span class="built_in">sync_with_stdio</span>(<span class="literal">false</span>);</span><br><span class="line">	cout&lt;&lt;<span class="string">&quot;Please Input The route of datax.pack:\n&quot;</span>;</span><br><span class="line">    string filename;</span><br><span class="line">    cin &gt;&gt; filename;</span><br><span class="line">    FILE* hfile;</span><br><span class="line">    hfile = <span class="built_in">fopen</span>(filename.<span class="built_in">c_str</span>(), <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">    _fseeki64(hfile, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="type">fpos_t</span> file_size = _ftelli64(hfile);</span><br><span class="line">    <span class="comment">//读取filepack头</span></span><br><span class="line">    _fseeki64(hfile, file_size - <span class="number">0x1C</span>, <span class="number">0</span>); <span class="comment">// 读取最后0x1C个字节</span></span><br><span class="line">    FilePackVer* filepacker = <span class="keyword">new</span> <span class="built_in">FilePackVer</span>();</span><br><span class="line">    <span class="built_in">fread</span>(filepacker, <span class="number">0x1C</span>,<span class="number">1</span> , hfile);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">string</span>(filepacker-&gt;sign) != <span class="string">&quot;FilePackVer3.1\x00\x00&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;FilePackVer Error!&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//读取HashData</span></span><br><span class="line">    HashData *hashdat = <span class="keyword">new</span> <span class="built_in">HashData</span>();</span><br><span class="line">    _fseeki64(hfile,file_size<span class="number">-0x440</span>,<span class="number">0</span>); <span class="comment">// 利用前面的FilePack结构体减去0x440的offset就是HashData结构体位置</span></span><br><span class="line">    <span class="built_in">fread</span>(hashdat,<span class="number">1</span>,<span class="number">0x440</span>,hfile);</span><br><span class="line">    <span class="comment">//数据的设置</span></span><br><span class="line">    <span class="keyword">if</span> (hashdat-&gt;Unkown &gt; <span class="number">8</span> || hashdat-&gt;Unkown &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        hashdat-&gt;Unkown = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    DWORD hash = <span class="built_in">Tohash</span>(&amp;hashdat-&gt;data,<span class="number">0x100</span>) &amp; <span class="number">0x0FFFFFFF</span>;</span><br><span class="line">    <span class="comment">//解码签名</span></span><br><span class="line">    <span class="built_in">dencrypt</span>(&amp;hashdat-&gt;sign, <span class="number">0x20</span>, hash);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strncmp</span>(hashdat-&gt;sign,<span class="string">&quot;8hr48uky,8ugi8ewra4g8d5vbf5hb5s6&quot;</span>,<span class="number">0x20</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;HashData Error!&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//开始解密文件</span></span><br><span class="line">    DWORD64 entry = ((<span class="type">long</span> <span class="type">long</span>)filepacker-&gt;entry_high &lt;&lt; <span class="number">32</span>) + (<span class="type">long</span> <span class="type">long</span>)filepacker-&gt;entry_low; <span class="comment">// cdq</span></span><br><span class="line">    BYTE* keyfilehash = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; filepacker-&gt;filecount; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        _fseeki64(hfile, entry, <span class="number">0</span>);</span><br><span class="line">        WORD character_count;</span><br><span class="line">        <span class="built_in">fread</span>(&amp;character_count, <span class="number">2</span>, <span class="number">1</span>, hfile);</span><br><span class="line">        <span class="type">wchar_t</span>* name = <span class="keyword">new</span> <span class="type">wchar_t</span>[character_count + <span class="number">1</span>]();</span><br><span class="line">        <span class="comment">//因为UTF16字节数是ASCII的两倍，所以要乘2</span></span><br><span class="line">        <span class="built_in">fread</span>(name, <span class="number">1</span>, <span class="number">2</span> * character_count, hfile);</span><br><span class="line">        <span class="comment">//解密文件名</span></span><br><span class="line">        <span class="built_in">DencryptFileName</span>(name, character_count, hash);</span><br><span class="line">        FileEntry *fentry = <span class="keyword">new</span> <span class="built_in">FileEntry</span>();</span><br><span class="line">        <span class="built_in">fread</span>(fentry, <span class="number">1</span>, <span class="number">0x1C</span>, hfile);</span><br><span class="line">        entry = _ftelli64(hfile);</span><br><span class="line">        <span class="comment">//文件读取</span></span><br><span class="line">        <span class="type">char</span>* filedata = <span class="keyword">new</span> <span class="type">char</span>[fentry-&gt;size];</span><br><span class="line">        _fseeki64(hfile, ((<span class="type">long</span> <span class="type">long</span>)fentry-&gt;offset_hight &lt;&lt; <span class="number">32</span>) + (<span class="type">long</span> <span class="type">long</span>)fentry-&gt;offset_low, <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">fread</span>(filedata, fentry-&gt;size, <span class="number">1</span>, hfile);</span><br><span class="line">  </span><br><span class="line">        <span class="comment">//解密文件</span></span><br><span class="line">        DWORD* filehash = <span class="literal">nullptr</span>;</span><br><span class="line">        <span class="keyword">if</span> (fentry-&gt;EncryptType == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            filehash = <span class="built_in">dencrypt3_hash</span>(<span class="number">0x40</span>, fentry-&gt;size, name, character_count, hash);</span><br><span class="line">            <span class="built_in">dencrypt3</span>(filedata, fentry-&gt;size, filehash);</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">wcsncmp</span>(name, <span class="string">L&quot;pack_keyfile_kfueheish15538fa9or.key&quot;</span>, character_count) == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                keyfilehash = <span class="built_in">dencypt4_keyfilehash</span>(filedata, fentry-&gt;size);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(fentry-&gt;EncryptType == <span class="number">2</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            filehash = <span class="built_in">dencrypt4_hash</span>(<span class="number">0x40</span>, fentry-&gt;size, name, character_count, hash);</span><br><span class="line">            <span class="built_in">dencrypt4</span>(filedata, fentry-&gt;size, filehash, keyfilehash);</span><br><span class="line">        &#125;</span><br><span class="line">        Dencrypt2DataOutput* Output = <span class="literal">nullptr</span>;</span><br><span class="line">        <span class="keyword">if</span> (fentry-&gt;isCompressed)</span><br><span class="line">        &#123;</span><br><span class="line">            Output = <span class="built_in">dencrypt2</span>(filedata, fentry-&gt;size, fentry-&gt;dencrypted_size, hash);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Output = <span class="keyword">new</span> <span class="built_in">Dencrypt2DataOutput</span>();</span><br><span class="line">            Output-&gt;data = (BYTE*)filedata;</span><br><span class="line">            Output-&gt;len = fentry-&gt;dencrypted_size;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//保存文件</span></span><br><span class="line">        wstring filename = <span class="built_in">wstring</span>(name);</span><br><span class="line">        filename = <span class="string">L&quot;ExtractData\\&quot;</span> + filename;</span><br><span class="line">        FILE* hOut = <span class="built_in">WideChar_CreateFile</span>(filename.<span class="built_in">c_str</span>());</span><br><span class="line">        std::<span class="built_in">fwrite</span>(Output-&gt;data, Output-&gt;len, <span class="number">1</span>, hOut);</span><br><span class="line">        std::<span class="built_in">fclose</span>(hOut);</span><br><span class="line">        <span class="keyword">delete</span> fentry, name, filedata, filehash, Output;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    std::<span class="built_in">fclose</span>(hfile);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h1><p>52pj那篇神作对于没接触过这种类型的逆向来说还是挺有难度的 无论是x32dbg的调试技巧还是一些数据敏感以及对结构体的重视都需要时间来适应<br>希望我的工作能给看到这篇文章的你带来一点启发</p>
<p>可以说万华镜是我最早接触到逆向工程的一个契机<br>去年暑假找万华镜玩的时候想要解出里面的CG 网上的Extractor都解不出来<br>兜兜转转就找到了52pj这篇神作~<br>去年11月初也尝试过开始逆 但逆不了一点…<br>现在又过了几个月 又学习到了更多知识&#x2F;逆向经验 磕磕绊绊也能将引擎摸索个大概<br>犹记几个月前还将逆出万华镜5作为逆向的终极目标(🤣) 看来目标还可以更大呐~</p>
<p>也许这就是逆向工程的魅力所在吧~ 能让我花整整一个周末 一直做一件事<br>当跟着一条条汇编抽丝剥茧 还原各种结构体 找到各个关键算法时 那种喜悦是难以言表的<br>希望能一直带着这种热忱继续学习逆向工程 </p>
<p><strong><code>&lt;&lt;&lt; Reversing &lt;&lt;&lt;</code></strong></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a target="_blank" rel="noopener" href="http://github.com/N0zoM1z0">Projects</a></li>
        
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%87%A0%E4%B8%AA%E5%85%B3%E9%94%AE%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-number">1.</span> <span class="toc-text">几个关键结构体</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#FilePackVer"><span class="toc-number">1.1.</span> <span class="toc-text">FilePackVer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HashData"><span class="toc-number">1.2.</span> <span class="toc-text">HashData</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HashVer"><span class="toc-number">1.3.</span> <span class="toc-text">HashVer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Decrypt2DataHead"><span class="toc-number">1.4.</span> <span class="toc-text">Decrypt2DataHead</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FileEntry"><span class="toc-number">1.5.</span> <span class="toc-text">FileEntry</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BF%91%E6%9C%882-%E6%B5%81%E7%A8%8B%E6%A2%B3%E7%90%86"><span class="toc-number">2.</span> <span class="toc-text">近月2 流程梳理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#FilePack"><span class="toc-number">2.1.</span> <span class="toc-text">FilePack</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">2.1.1.</span> <span class="toc-text">文件读取初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E8%A7%A3%E5%AF%86"><span class="toc-number">2.1.2.</span> <span class="toc-text">文件解密</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%87%E5%8D%8E%E9%95%9C5"><span class="toc-number">3.</span> <span class="toc-text">万华镜5</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#decrypt4"><span class="toc-number">3.1.</span> <span class="toc-text">decrypt4</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9E%E6%BA%AF%E6%89%BEkey"><span class="toc-number">3.1.1.</span> <span class="toc-text">回溯找key[]</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%A7%A3%E5%AF%86%E4%BB%A3%E7%A0%81"><span class="toc-number">4.</span> <span class="toc-text">解密代码</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%86%99%E5%9C%A8%E6%9C%80%E5%90%8E"><span class="toc-number">5.</span> <span class="toc-text">写在最后</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/&text=万华镜逆向"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/&title=万华镜逆向"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/&is_video=false&description=万华镜逆向"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=万华镜逆向&body=Check out this article: http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/&title=万华镜逆向"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/&title=万华镜逆向"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/&title=万华镜逆向"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/&title=万华镜逆向"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/&name=万华镜逆向&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/&t=万华镜逆向"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2024
    N0zoM1z0
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
      --><li><a href="/">Home</a></li><!--
    --><!--
      --><li><a href="/about/">About</a></li><!--
    --><!--
      --><li><a href="/archives/">Writing</a></li><!--
    --><!--
      --><li><a target="_blank" rel="noopener" href="http://github.com/N0zoM1z0">Projects</a></li><!--
    --><!--
      --><li><a href="/search/">Search</a></li><!--
    -->
      </ul>
      <ul>
        
          <!-- 不蒜子统计 -->
          <span id="busuanzi_container_site_pv">
              Friend Link: Kasaki·Nozomi
          </span>
          <span class="post-meta-divider">|</span>
          <span id="busuanzi_container_site_uv" style='display:none'>
                  Yoroizuka·Mizore
          </span>
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        
      </ul>
    </nav>
  </div>
  
</footer>


    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>

<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="教程 1234567Struct FilePackVer&#123;    char sign[0x10];    DWORD size?;    DWORD entry?;    DWORD unknown;&#125;;   1234567891011121314151617181920212223242526272829303132DWORD Tohash(void* data, int l">
<meta property="og:type" content="article">
<meta property="og:title" content="万华镜逆向(初试)">
<meta property="og:url" content="http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/index.html">
<meta property="og:site_name" content="N0zoM1z0">
<meta property="og:description" content="教程 1234567Struct FilePackVer&#123;    char sign[0x10];    DWORD size?;    DWORD entry?;    DWORD unknown;&#125;;   1234567891011121314151617181920212223242526272829303132DWORD Tohash(void* data, int l">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-1.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-2.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-3.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-4.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-5.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-6.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-7.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-8.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-9.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-10.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-11.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-12.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-13.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-14.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-15.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-16.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-17.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-18.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-19.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-20.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-21.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-22.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-23.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-24.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-25.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-26.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-27.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-28.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-29.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-30.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-31.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-32.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-33.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-34.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-35.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-36.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-37.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-38.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-39.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-40.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-41.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-42.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-43.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-44.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-45.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-46.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-47.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-52.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-49.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-50.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-51.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-53.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-54.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-55.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-56.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-57.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-58.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-59.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-60.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-61.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-62.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-64.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-65.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-66.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-67.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-68.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-69.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-70.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-71.png">
<meta property="og:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image-72.png">
<meta property="article:published_time" content="2024-03-03T07:05:25.000Z">
<meta property="article:modified_time" content="2024-03-03T07:07:12.341Z">
<meta property="article:author" content="N0zoM1z0">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="d:/GithubBlog/NozoBlog/source/_posts/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/images/image.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>万华镜逆向(初试)</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.1.1"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/N0zoM1z0">Projects</a></li><!--
     --><!--
       --><li><a href="/search/">Search</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" aria-label="Next post" href="/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/&text=万华镜逆向(初试)"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/&title=万华镜逆向(初试)"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/&is_video=false&description=万华镜逆向(初试)"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=万华镜逆向(初试)&body=Check out this article: http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/&title=万华镜逆向(初试)"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/&title=万华镜逆向(初试)"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/&title=万华镜逆向(初试)"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/&title=万华镜逆向(初试)"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/&name=万华镜逆向(初试)&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/&t=万华镜逆向(初试)"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%99%E7%A8%8B"><span class="toc-number">1.</span> <span class="toc-text">教程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E6%93%8D%E5%A4%8D%E7%8E%B0"><span class="toc-number">2.</span> <span class="toc-text">实操复现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-number">2.1.</span> <span class="toc-text">信息收集</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#x32dbg-%E5%8A%A8%E6%80%81%E8%B0%83%E8%AF%95"><span class="toc-number">2.2.</span> <span class="toc-text">x32dbg 动态调试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E6%9D%A1%E4%BB%B6%E6%96%AD%E7%82%B9"><span class="toc-number">2.2.1.</span> <span class="toc-text">设置条件断点</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CreateFileW"><span class="toc-number">2.2.1.1.</span> <span class="toc-text">CreateFileW</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ReadFile"><span class="toc-number">2.2.1.2.</span> <span class="toc-text">ReadFile</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SetFilePointer"><span class="toc-number">2.2.1.3.</span> <span class="toc-text">SetFilePointer</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HashVer%E7%9A%84%E5%A4%84%E7%90%86"><span class="toc-number">2.2.2.</span> <span class="toc-text">HashVer的处理</span></a></li></ol></li></ol></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        万华镜逆向(初试)
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">N0zoM1z0</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2024-03-03T07:05:25.000Z" class="dt-published" itemprop="datePublished">2024-03-03</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h1 id="教程"><a href="#教程" class="headerlink" title="教程"></a>教程</h1><p><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image.png" alt="img"><br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-1.png" alt="img"><br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-2.png" alt="img"><br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-3.png" alt="img"><br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-4.png" alt="img"><br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-5.png" alt="img"><br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-6.png" alt="img"><br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-7.png" alt="img"></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Struct FilePackVer</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> sign[<span class="number">0x10</span>];</span><br><span class="line">    DWORD size?;</span><br><span class="line">    DWORD entry?;</span><br><span class="line">    DWORD unknown;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-8.png" alt="img"><br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-9.png" alt="img"><br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-10.png" alt="img"><br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-11.png" alt="img"><br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-12.png" alt="img"></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD <span class="title">Tohash</span><span class="params">(<span class="type">void</span>* data, <span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (len &lt; <span class="number">8</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//准备工作</span></span><br><span class="line">    __m64 mm0 = _mm_cvtsi32_si64(<span class="number">0</span>);</span><br><span class="line">    __m64 mm1;</span><br><span class="line">    __m64 mm2 = _mm_cvtsi32_si64(<span class="number">0</span>);</span><br><span class="line">    DWORD key = <span class="number">0xA35793A7</span>;</span><br><span class="line">    __m64 mm3 = _mm_cvtsi32_si64(key);</span><br><span class="line">     mm3 = _m_punpckldq(mm3, mm3);</span><br><span class="line">     __m64* pdata=(__m64*)data;</span><br><span class="line">    <span class="comment">//开始循环计算hash</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; (len &gt;&gt; <span class="number">3</span>); i++)</span><br><span class="line">    &#123;</span><br><span class="line">        mm1 = *pdata;</span><br><span class="line">        pdata++;</span><br><span class="line">        mm2 = _m_paddw(mm2, mm3);</span><br><span class="line">        mm1 = _m_pxor(mm1, mm2);</span><br><span class="line">        mm0 = _m_paddw(mm0, mm1);</span><br><span class="line">        mm1 = mm0;</span><br><span class="line">        mm0 = _m_pslldi(mm0, <span class="number">3</span>);</span><br><span class="line">        mm1 = _m_psrldi(mm1, <span class="number">0x1D</span>);</span><br><span class="line">        mm0 = _m_por(mm1, mm0);</span><br><span class="line">    &#125;</span><br><span class="line">    mm1 = _m_psrlqi(mm0, <span class="number">32</span>);</span><br><span class="line">    DWORD result = _mm_cvtsi64_si32(_m_pmaddwd(mm0, mm1));</span><br><span class="line">    _m_empty();<span class="comment">//复位浮点寄存器</span></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-13.png" alt="img"><br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-14.png" alt="img"></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">dencrypt</span><span class="params">(<span class="type">void</span>* data,<span class="type">unsigned</span> <span class="type">int</span> len, DWORD hash)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (len &gt;&gt; <span class="number">3</span> == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//准备工作</span></span><br><span class="line">    DWORD key1 = <span class="number">0xA73C5F9D</span>;</span><br><span class="line">    DWORD key2 = <span class="number">0xCE24F523</span>;</span><br><span class="line">    DWORD key3 = (len + hash)^ <span class="number">0xFEC9753E</span>;</span><br><span class="line">    __m64 mm7 = _mm_cvtsi32_si64(key1);</span><br><span class="line">    mm7 = _m_punpckldq(mm7, mm7);</span><br><span class="line">    __m64 mm6 = _mm_cvtsi32_si64(key2);</span><br><span class="line">    mm6 = _m_punpckldq(mm6, mm6);</span><br><span class="line">    __m64 mm5 = _mm_cvtsi32_si64(key3);</span><br><span class="line">    mm5 = _m_punpckldq(mm5, mm5);</span><br><span class="line">    __m64* datapos = (__m64*)data;</span><br><span class="line">    __m64 mm0;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; len &gt;&gt; <span class="number">3</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        mm7 = _m_paddd(mm7, mm6);</span><br><span class="line">        mm7 = _m_pxor(mm7, mm5);</span><br><span class="line">        mm0 = *datapos;</span><br><span class="line">        mm0 = _m_pxor(mm0, mm7);</span><br><span class="line">        mm5 = mm0;</span><br><span class="line">        *datapos = mm0;</span><br><span class="line">        datapos++;</span><br><span class="line">    &#125;</span><br><span class="line">    _m_empty();<span class="comment">//复位浮点寄存器</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-15.png" alt="img"></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">004</span>ED95B         | <span class="number">8</span>D85 B4FBFFFF   | lea eax,dword ptr ss:[ebp<span class="number">-0x44C</span>]                   | 缓冲区</span><br><span class="line"><span class="number">004</span>ED961         | <span class="number">8</span>D95 B8FBFFFF   | lea edx,dword ptr ss:[ebp<span class="number">-0x448</span>]                   | 需要转换的字符串</span><br><span class="line"><span class="number">004</span>ED967         | B9 <span class="number">20000000</span>     | mov ecx,<span class="number">0x20</span>                                       | 字符串长度</span><br><span class="line"><span class="number">004</span>ED96C         | E8 <span class="number">9F</span>9EF1FF     | call &lt;月に寄りそう乙女の作法<span class="number">22.</span>multibyte2widecode&gt;            | 字符转unicode</span><br><span class="line"><span class="number">004</span>ED971         | <span class="number">8B</span>85 B4FBFFFF   | mov eax,dword ptr ss:[ebp<span class="number">-0x44C</span>]                   |</span><br><span class="line"><span class="number">004</span>ED977         | BA <span class="number">28</span>DB4E00     | mov edx,月に寄りそう乙女の作法<span class="number">22.4</span>EDB28                       | <span class="number">4</span>EDB28:<span class="string">L&quot;8hr48uky,8ugi8ewra4g8d5vbf5hb5s6&quot;</span></span><br><span class="line"><span class="number">004</span>ED97C         | E8 <span class="number">7F</span>A3F1FF     | call &lt;月に寄りそう乙女の作法<span class="number">22.</span>cmp_sign&gt;                      | 比对签名</span><br></pre></td></tr></table></figure>

<p><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-16.png" alt="img"></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">FilePackVer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> sign[<span class="number">0x10</span>];</span><br><span class="line">    DWORD size?;</span><br><span class="line">    QWORD entry?; <span class="comment">//写程序的时候需要变成两个int型表示低位和高位，直接用64位整型读取文件的时候会少读这部分数据</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-17.png" alt="img"></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">HashData</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> sign[<span class="number">0x20</span>];</span><br><span class="line">    DWORD HashVerSize;</span><br><span class="line">    <span class="type">char</span> data[<span class="number">0x100</span>];</span><br><span class="line">    DWORD Unkown; <span class="comment">//就是那个大于8或者小于0就设置成0的数据</span></span><br><span class="line">    <span class="type">char</span> Blank[<span class="number">0x2F8</span>]; <span class="comment">//一大片用0填充的数据，应该是用于占位</span></span><br><span class="line">    FilePackVer fpacker;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-18.png" alt="img"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">004ED9D2         | E8 397DF1FF     | call 月に寄りそう乙女の作法22.405710                          | 构造类？</span><br></pre></td></tr></table></figure>

<p><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-19.png" alt="img"><br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-20.png" alt="img"><br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-21.png" alt="img"><br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-22.png" alt="img"><br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-23.png" alt="img"><br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-24.png" alt="img"><br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-25.png" alt="img"><br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-26.png" alt="img"><br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-27.png" alt="img"></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//chr是逐个从数据中取出的字节，t_pos是表的下标</span></span><br><span class="line"><span class="comment">//这里有两张表，一张是table，刚刚从0-FF复制过来的，另一张是other，不做任何预处理</span></span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (chr &gt; <span class="number">0x7F</span>u)</span><br><span class="line">    &#123;</span><br><span class="line">        t_pos += chr - <span class="number">127</span>;</span><br><span class="line">        chr = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (t_pos &gt; <span class="number">0xFF</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; chr + <span class="number">1</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        table[t_pos] = *datapos++;</span><br><span class="line">        <span class="keyword">if</span> (t_pos != (<span class="type">unsigned</span> __int8)table[t_pos])</span><br><span class="line">        &#123;</span><br><span class="line">            other[t_pos] = *datapos++;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        ++t_pos;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (t_pos &gt; <span class="number">0xFF</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    chr = *datapos++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-28.png" alt="img"></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Dencrypt2DataOutput* <span class="title">dencrypt2</span><span class="params">(<span class="type">void</span>* data, <span class="type">unsigned</span> <span class="type">int</span> len,<span class="type">unsigned</span> <span class="type">int</span> dencrypted_len, DWORD hash)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> Sampletable[<span class="number">0x100</span>],table[<span class="number">0x100</span>],other[<span class="number">0x100</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">0x100</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        Sampletable[i] = i;</span><br><span class="line">    &#125;</span><br><span class="line">    Dencrypt2DataHead* head = (Dencrypt2DataHead*)data;</span><br><span class="line">    <span class="comment">//对比开头是否为0xFF425031</span></span><br><span class="line">    <span class="keyword">if</span> (head-&gt;sign != <span class="number">0xFF435031</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;数据不符合解码条件&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (head-&gt;size&gt; <span class="number">0x20000000</span>u)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;数据量大于0x20000000&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    Dencrypt2DataOutput* Output = <span class="keyword">new</span> <span class="built_in">Dencrypt2DataOutput</span>();</span><br><span class="line">    Output-&gt;len = dencrypted_len;</span><br><span class="line">    Output-&gt;data = <span class="keyword">new</span> BYTE[dencrypted_len + <span class="number">1</span>];</span><br><span class="line">    BYTE* outputbuff = Output-&gt;data;</span><br><span class="line">  </span><br><span class="line">    BYTE* datapos = (BYTE*)data + <span class="built_in">sizeof</span>(Dencrypt2DataHead);</span><br><span class="line">    BYTE* data_start = datapos;</span><br><span class="line">    BYTE* data_end = (BYTE*)data + len;</span><br><span class="line">    BYTE chr;</span><br><span class="line">    <span class="type">int</span> t_pos;</span><br><span class="line">    <span class="type">int</span> size;</span><br><span class="line">    <span class="keyword">while</span> (data_start &lt; data_end)</span><br><span class="line">    &#123;</span><br><span class="line">        chr = *data_start;</span><br><span class="line">        datapos = data_start + <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">memcpy</span>(table, Sampletable, <span class="number">0x100</span>);</span><br><span class="line">        t_pos = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//建表循环</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (chr &gt; <span class="number">0x7F</span>u)</span><br><span class="line">            &#123;</span><br><span class="line">                t_pos += chr - <span class="number">127</span>;</span><br><span class="line">                chr = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (t_pos &gt; <span class="number">0xFF</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">  </span><br><span class="line">            <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; chr + <span class="number">1</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                table[t_pos] = *datapos++;</span><br><span class="line">                <span class="keyword">if</span> (t_pos != (<span class="type">unsigned</span> __int8)table[t_pos])</span><br><span class="line">                &#123;</span><br><span class="line">                    other[t_pos] = *datapos++;</span><br><span class="line">                &#125;</span><br><span class="line">  </span><br><span class="line">                ++t_pos;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (t_pos &gt; <span class="number">0xFF</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            chr = *datapos++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//数据类型判断</span></span><br><span class="line">        <span class="keyword">if</span> ((head-&gt;isWordType &amp; <span class="number">1</span>) == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            size = *(WORD*)datapos;</span><br><span class="line">            data_start = (datapos + <span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            size = *(DWORD*)datapos;</span><br><span class="line">            data_start = (datapos + <span class="number">4</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//解密循环</span></span><br><span class="line">        stack&lt;BYTE&gt; stack;</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            BYTE result;</span><br><span class="line">            <span class="keyword">if</span> (stack.<span class="built_in">size</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                result = stack.<span class="built_in">top</span>();</span><br><span class="line">                stack.<span class="built_in">pop</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (!size)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                size--;</span><br><span class="line">                result = *data_start;</span><br><span class="line">                data_start++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (result == (BYTE)table[result])</span><br><span class="line">            &#123;</span><br><span class="line">                *outputbuff = result;</span><br><span class="line">                outputbuff++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                stack.<span class="built_in">push</span>(other[result]);</span><br><span class="line">                stack.<span class="built_in">push</span>(table[result]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Output;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-29.png" alt="img"></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">HashVer </span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">char</span> sign[<span class="number">16</span>];</span><br><span class="line">        DWORD  table_size;</span><br><span class="line">    DWORD  file_count;</span><br><span class="line">    DWORD  index_size;</span><br><span class="line">    DWORD  data_size;</span><br><span class="line">    DWORD  iscompressed;</span><br><span class="line">    <span class="type">char</span> unknown1[<span class="number">32</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-30.png" alt="img"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">004E4C1E         | 53              | push ebx                                           |</span><br><span class="line">004E4C1F         | 56              | push esi                                           |</span><br><span class="line">004E4C20         | 57              | push edi                                           | edi:&quot;0yC&quot;</span><br><span class="line">004E4C21         | 33DB            | xor ebx,ebx                                        |</span><br><span class="line">004E4C23         | 895D FC         | mov dword ptr ss:[ebp-0x4],ebx                     |</span><br><span class="line">004E4C26         | 894D F0         | mov dword ptr ss:[ebp-0x10],ecx                    |</span><br><span class="line">004E4C29         | 8BDA            | mov ebx,edx                                        | edx:&quot;l;p&quot;</span><br><span class="line">004E4C2B         | 8945 F8         | mov dword ptr ss:[ebp-0x8],eax                     |</span><br><span class="line">004E4C2E         | 33C0            | xor eax,eax                                        |</span><br><span class="line">004E4C30         | 55              | push ebp                                           |</span><br><span class="line">004E4C31         | 68 334D4E00     | push 月に寄りそう乙女の作法22.4E4D33                          |</span><br><span class="line">004E4C36         | 64:FF30         | push dword ptr fs:[eax]                            | eax:&quot;^??~8&quot;</span><br><span class="line">004E4C39         | 64:8920         | mov dword ptr fs:[eax],esp                         |</span><br><span class="line">004E4C3C         | 8BC3            | mov eax,ebx                                        | eax等于hash</span><br><span class="line">004E4C3E         | C1E8 10         | shr eax,0x10                                       |</span><br><span class="line">004E4C41         | 25 FFFF0000     | and eax,0xFFFF                                     |</span><br><span class="line">004E4C46         | 33D8            | xor ebx,eax                                        | key = ((hash &gt;&gt; 0x10) &amp; 0xFFFF) ^ hash</span><br><span class="line">004E4C48         | 8B45 F0         | mov eax,dword ptr ss:[ebp-0x10]                    |</span><br><span class="line">004E4C4B         | 33D2            | xor edx,edx                                        | edx:&quot;l;p&quot;</span><br><span class="line">004E4C4D         | E8 D629F2FF     | call 月に寄りそう乙女の作法22.407628                          |</span><br><span class="line">004E4C52         | 8D55 E6         | lea edx,dword ptr ss:[ebp-0x1A]                    |</span><br><span class="line">004E4C55         | B9 02000000     | mov ecx,0x2                                        |</span><br><span class="line">004E4C5A         | 8B45 F8         | mov eax,dword ptr ss:[ebp-0x8]                     |</span><br><span class="line">004E4C5D         | 8B30            | mov esi,dword ptr ds:[eax]                         |</span><br><span class="line">004E4C5F         | FF56 0C         | call dword ptr ds:[esi+0xC]                        | 读取文件</span><br><span class="line">004E4C62         | 66:837D E6 00   | cmp word ptr ss:[ebp-0x1A],0x0                     | 读出的值是否大于等于0</span><br><span class="line">004E4C67         | 7D 16           | jge 月に寄りそう乙女の作法22.4E4C7F                           |</span><br><span class="line">004E4C69         | B9 504D4E00     | mov ecx,月に寄りそう乙女の作法22.4E4D50                       | 4E4D50:L&quot;_LoadStringCode:Out of length error.&quot;</span><br><span class="line">004E4C6E         | B2 01           | mov dl,0x1                                         | 小于0就报错</span><br><span class="line">004E4C70         | A1 D4004100     | mov eax,dword ptr ds:[0x4100D4]                    |</span><br><span class="line">004E4C75         | E8 D280F3FF     | call 月に寄りそう乙女の作法22.41CD4C                          |</span><br><span class="line">004E4C7A         | E9 98000000     | jmp 月に寄りそう乙女の作法22.4E4D17                           |</span><br><span class="line">004E4C7F         | 0FBF75 E6       | movsx esi,word ptr ss:[ebp-0x1A]                   |</span><br><span class="line">004E4C83         | 85F6            | test esi,esi                                       |</span><br><span class="line">004E4C85         | 0F8E 8C000000   | jle 月に寄りそう乙女の作法22.4E4D17                           |</span><br><span class="line">004E4C8B         | 56              | push esi                                           | Arg1</span><br><span class="line">004E4C8C         | 8D45 FC         | lea eax,dword ptr ss:[ebp-0x4]                     |</span><br><span class="line">004E4C8F         | B9 01000000     | mov ecx,0x1                                        |</span><br><span class="line">004E4C94         | 8B15 F44B4E00   | mov edx,dword ptr ds:[0x4E4BF4]                    | edx:&quot;l;p&quot;</span><br><span class="line">004E4C9A         | E8 6D44F2FF     | call 月に寄りそう乙女の作法22.40910C                          | Dynarraysetlength</span><br><span class="line">004E4C9F         | 83C4 04         | add esp,0x4                                        |</span><br><span class="line">004E4CA2         | 8B45 F0         | mov eax,dword ptr ss:[ebp-0x10]                    |</span><br><span class="line">004E4CA5         | 8BD6            | mov edx,esi                                        | edx:&quot;l;p&quot;</span><br><span class="line">004E4CA7         | E8 F82CF2FF     | call 月に寄りそう乙女の作法22.4079A4                          |</span><br><span class="line">004E4CAC         | 8BCE            | mov ecx,esi                                        |</span><br><span class="line">004E4CAE         | 03C9            | add ecx,ecx                                        |</span><br><span class="line">004E4CB0         | 8B55 FC         | mov edx,dword ptr ss:[ebp-0x4]                     |</span><br><span class="line">004E4CB3         | 8B45 F8         | mov eax,dword ptr ss:[ebp-0x8]                     |</span><br><span class="line">004E4CB6         | 8B38            | mov edi,dword ptr ds:[eax]                         | edi:&quot;0yC&quot;</span><br><span class="line">004E4CB8         | FF57 0C         | call dword ptr ds:[edi+0xC]                        | 读取文件</span><br><span class="line">004E4CBB         | 8BC6            | mov eax,esi                                        | 文件名解密开始</span><br><span class="line">004E4CBD         | 35 133E0000     | xor eax,0x3E13                                     | 这里len异或了3e13</span><br><span class="line">004E4CC2         | 33D8            | xor ebx,eax                                        | 这里异或了之前算出的Key</span><br><span class="line">004E4CC4         | 8BC6            | mov eax,esi                                        |</span><br><span class="line">004E4CC6         | F7EE            | imul esi                                           | eax=pow(esi,2)</span><br><span class="line">004E4CC8         | 33D8            | xor ebx,eax                                        | 继续异或</span><br><span class="line">004E4CCA         | 895D EC         | mov dword ptr ss:[ebp-0x14],ebx                    |</span><br><span class="line">004E4CCD         | 8165 EC FFFF000 | and dword ptr ss:[ebp-0x14],0xFFFF                 |</span><br><span class="line">004E4CD4         | 8B5D EC         | mov ebx,dword ptr ss:[ebp-0x14]                    |</span><br><span class="line">004E4CD7         | 8B7D FC         | mov edi,dword ptr ss:[ebp-0x4]                     |</span><br><span class="line">004E4CDA         | 8B45 F0         | mov eax,dword ptr ss:[ebp-0x10]                    |</span><br><span class="line">004E4CDD         | E8 AA33F2FF     | call 月に寄りそう乙女の作法22.40808C                          |</span><br><span class="line">004E4CE2         | 8945 E8         | mov dword ptr ss:[ebp-0x18],eax                    |</span><br><span class="line">004E4CE5         | 8BC6            | mov eax,esi                                        |</span><br><span class="line">004E4CE7         | 48              | dec eax                                            |</span><br><span class="line">004E4CE8         | 85C0            | test eax,eax                                       |</span><br><span class="line">004E4CEA         | 7C 2B           | jl 月に寄りそう乙女の作法22.4E4D17                            |</span><br><span class="line">004E4CEC         | 40              | inc eax                                            |</span><br><span class="line">004E4CED         | 33D2            | xor edx,edx                                        | edx:&quot;l;p&quot;</span><br><span class="line">004E4CEF         | C1E3 03         | shl ebx,0x3                                        | 解密循环 ebx初值为刚刚算出的key</span><br><span class="line">004E4CF2         | 8D0C1A          | lea ecx,dword ptr ds:[edx+ebx]                     | ecx = edx+ebx</span><br><span class="line">004E4CF5         | 034D EC         | add ecx,dword ptr ss:[ebp-0x14]                    | ecx = ecx+key</span><br><span class="line">004E4CF8         | 81E1 FFFF0000   | and ecx,0xFFFF                                     | ecx = ecx &amp; 0xFFFF</span><br><span class="line">004E4CFE         | 8BD9            | mov ebx,ecx                                        | ebx = ecx</span><br><span class="line">004E4D00         | 0FB70F          | movzx ecx,word ptr ds:[edi]                        | ecx = (WORD)文件名数据</span><br><span class="line">004E4D03         | 66:33CB         | xor cx,bx                                          | result = cx ^ bx</span><br><span class="line">004E4D06         | 8B75 E8         | mov esi,dword ptr ss:[ebp-0x18]                    |</span><br><span class="line">004E4D09         | 66:890E         | mov word ptr ds:[esi],cx                           |</span><br><span class="line">004E4D0C         | 83C7 02         | add edi,0x2                                        | edi:&quot;0yC&quot;</span><br><span class="line">004E4D0F         | 8345 E8 02      | add dword ptr ss:[ebp-0x18],0x2                    |</span><br><span class="line">004E4D13         | 42              | inc edx                                            | edx为循环次数</span><br><span class="line">004E4D14         | 48              | dec eax                                            |</span><br><span class="line">004E4D15         | 75 D8           | jne 月に寄りそう乙女の作法22.4E4CEF                           |</span><br><span class="line">004E4D17         | 33C0            | xor eax,eax                                        |</span><br><span class="line">004E4D19         | 5A              | pop edx                                            | edx:&quot;l;p&quot;</span><br><span class="line">004E4D1A         | 59              | pop ecx                                            |</span><br><span class="line">004E4D1B         | 59              | pop ecx                                            |</span><br><span class="line">004E4D1C         | 64:8910         | mov dword ptr fs:[eax],edx                         | eax:&quot;^??~8&quot;, edx:&quot;l;p&quot;</span><br><span class="line">004E4D1F         | 68 3A4D4E00     | push 月に寄りそう乙女の作法22.4E4D3A                          | Arg1 = &quot;_^[嬪]?&quot;</span><br><span class="line">004E4D24         | 8D45 FC         | lea eax,dword ptr ss:[ebp-0x4]                     |</span><br><span class="line">004E4D27         | 8B15 F44B4E00   | mov edx,dword ptr ds:[0x4E4BF4]                    | edx:&quot;l;p&quot;</span><br><span class="line">004E4D2D         | E8 FA44F2FF     | call 月に寄りそう乙女の作法22.40922C                          | sub_40922C</span><br><span class="line">004E4D32         | C3              | ret                                                |</span><br></pre></td></tr></table></figure>

<p><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-31.png" alt="img"><br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-32.png" alt="img"></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">FileEntry</span></span><br><span class="line">&#123;</span><br><span class="line">        QWORD offset; <span class="comment">//老规矩写代码要写成两个int</span></span><br><span class="line">    DWORD size;</span><br><span class="line">    DWORD dencrypted_size;</span><br><span class="line">    DWORD isCompressed;</span><br><span class="line">    DWORD unkown1; </span><br><span class="line">    DWORD unkown2;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-33.png" alt="img"><br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-34.png" alt="img"><br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-35.png" alt="img"><br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-36.png" alt="img"></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">004</span>ECE7C         | <span class="number">55</span>              | push ebp                                           |</span><br><span class="line"><span class="number">004</span>ECE7D         | <span class="number">8B</span>EC            | mov ebp,esp                                        |</span><br><span class="line"><span class="number">004</span>ECE7F         | <span class="number">83</span>C4 F8         | add esp,<span class="number">0xFFFFFFF8</span>                                 |</span><br><span class="line"><span class="number">004</span>ECE82         | <span class="number">53</span>              | push ebx                                           |</span><br><span class="line"><span class="number">004</span>ECE83         | <span class="number">56</span>              | push esi                                           |</span><br><span class="line"><span class="number">004</span>ECE84         | <span class="number">57</span>              | push edi                                           | edi:<span class="string">&quot;0yC&quot;</span></span><br><span class="line"><span class="number">004</span>ECE85         | <span class="number">8955</span> F8         | mov dword ptr ss:[ebp<span class="number">-0x8</span>],edx                     |</span><br><span class="line"><span class="number">004</span>ECE88         | <span class="number">8945</span> FC         | mov dword ptr ss:[ebp<span class="number">-0x4</span>],eax                     |</span><br><span class="line"><span class="number">004</span>ECE8B         | BB <span class="number">32F</span>58500     | mov ebx,<span class="number">0x85F532</span>                                   | 这两个值之后会用到</span><br><span class="line"><span class="number">004</span>ECE90         | BE <span class="number">41F</span>63300     | mov esi,<span class="number">0x33F641</span>                                   |</span><br><span class="line"><span class="number">004</span>ECE95         | <span class="number">8B</span>45 <span class="number">08</span>         | mov eax,dword ptr ss:[ebp+<span class="number">0x8</span>]                     |</span><br><span class="line"><span class="number">004</span>ECE98         | <span class="number">8B</span>40 <span class="number">08</span>         | mov eax,dword ptr ds:[eax+<span class="number">0x8</span>]                     |</span><br><span class="line"><span class="number">004</span>ECE9B         | <span class="number">85</span>C0            | test eax,eax                                       |</span><br><span class="line"><span class="number">004</span>ECE9D         | <span class="number">74</span> <span class="number">1</span>C           | je 月に寄りそう乙女の作法<span class="number">22.4</span>ECEBB                            |</span><br><span class="line"><span class="number">004</span>ECE9F         | <span class="number">8B</span>D0            | mov edx,eax                                        | edx:<span class="string">&quot;l;p&quot;</span></span><br><span class="line"><span class="number">004</span>ECEA1         | <span class="number">83</span>EA <span class="number">0</span>A         | sub edx,<span class="number">0xA</span>                                        | edx:<span class="string">&quot;l;p&quot;</span></span><br><span class="line"><span class="number">004</span>ECEA4         | <span class="number">66</span>:<span class="number">833</span>A <span class="number">02</span>      | cmp word ptr ds:[edx],<span class="number">0x2</span>                          | edx:<span class="string">&quot;l;p&quot;</span></span><br><span class="line"><span class="number">004</span>ECEA8         | <span class="number">74</span> <span class="number">11</span>           | je 月に寄りそう乙女の作法<span class="number">22.4</span>ECEBB                            |</span><br><span class="line"><span class="number">004</span>ECEAA         | <span class="number">8B</span>45 <span class="number">08</span>         | mov eax,dword ptr ss:[ebp+<span class="number">0x8</span>]                     |</span><br><span class="line"><span class="number">004</span>ECEAD         | <span class="number">8B</span>50 <span class="number">08</span>         | mov edx,dword ptr ds:[eax+<span class="number">0x8</span>]                     | edx:<span class="string">&quot;l;p&quot;</span></span><br><span class="line"><span class="number">004</span>ECEB0         | <span class="number">8B</span>45 <span class="number">08</span>         | mov eax,dword ptr ss:[ebp+<span class="number">0x8</span>]                     |</span><br><span class="line"><span class="number">004</span>ECEB3         | <span class="number">83</span>C0 <span class="number">08</span>         | add eax,<span class="number">0x8</span>                                        |</span><br><span class="line"><span class="number">004</span>ECEB6         | E8 F59CF1FF     | call 月に寄りそう乙女の作法<span class="number">22.406B</span>B0                          |</span><br><span class="line"><span class="number">004</span>ECEBB         | <span class="number">85</span>C0            | test eax,eax                                       |</span><br><span class="line"><span class="number">004</span>ECEBD         | <span class="number">74</span> <span class="number">05</span>           | je 月に寄りそう乙女の作法<span class="number">22.4</span>ECEC4                            |</span><br><span class="line"><span class="number">004</span>ECEBF         | <span class="number">83E8</span> <span class="number">04</span>         | sub eax,<span class="number">0x4</span>                                        |</span><br><span class="line"><span class="number">004</span>ECEC2         | <span class="number">8B</span>00            | mov eax,dword ptr ds:[eax]                         | eax=文件名字符数</span><br><span class="line"><span class="number">004</span>ECEC4         | <span class="number">8B</span>D0            | mov edx,eax                                        | edx:<span class="string">&quot;l;p&quot;</span></span><br><span class="line"><span class="number">004</span>ECEC6         | <span class="number">4</span>A              | dec edx                                            | edx:<span class="string">&quot;l;p&quot;</span></span><br><span class="line"><span class="number">004</span>ECEC7         | <span class="number">85</span>D2            | test edx,edx                                       | edx:<span class="string">&quot;l;p&quot;</span></span><br><span class="line"><span class="number">004</span>ECEC9         | <span class="number">7</span>C <span class="number">20</span>           | jl 月に寄りそう乙女の作法<span class="number">22.4</span>ECEEB                            |</span><br><span class="line"><span class="number">004</span>ECECB         | <span class="number">42</span>              | inc edx                                            | edx:<span class="string">&quot;l;p&quot;</span></span><br><span class="line"><span class="number">004</span>ECECC         | <span class="number">33</span>C0            | <span class="keyword">xor</span> eax,eax                                        |</span><br><span class="line"><span class="number">004</span>ECECE         | <span class="number">8</span>D48 <span class="number">01</span>         | lea ecx,dword ptr ds:[eax+<span class="number">0x1</span>]                     | 循环开始</span><br><span class="line"><span class="number">004</span>ECED1         | <span class="number">8B</span>7D <span class="number">08</span>         | mov edi,dword ptr ss:[ebp+<span class="number">0x8</span>]                     |</span><br><span class="line"><span class="number">004</span>ECED4         | <span class="number">8B</span>7F <span class="number">08</span>         | mov edi,dword ptr ds:[edi+<span class="number">0x8</span>]                     | edi:<span class="string">&quot;0yC&quot;</span></span><br><span class="line"><span class="number">004</span>ECED7         | <span class="number">0F</span>B77C4F FE     | movzx edi,word ptr ds:[edi+ecx*<span class="number">2</span><span class="number">-0x2</span>]              | 取文件名的每个字符</span><br><span class="line"><span class="number">004</span>ECEDC         | <span class="number">8B</span>C8            | mov ecx,eax                                        | eax为循环次数</span><br><span class="line"><span class="number">004</span>ECEDE         | <span class="number">83E1</span> <span class="number">07</span>         | <span class="keyword">and</span> ecx,<span class="number">0x7</span>                                        | ecx=eax &amp; <span class="number">7</span></span><br><span class="line"><span class="number">004</span>ECEE1         | D3E7            | shl edi,cl                                         | edi为文件名word字符</span><br><span class="line"><span class="number">004</span>ECEE3         | <span class="number">03</span>DF            | add ebx,edi                                        | ebx=ebx+(edi &lt;&lt; cl)</span><br><span class="line"><span class="number">004</span>ECEE5         | <span class="number">33F</span>3            | <span class="keyword">xor</span> esi,ebx                                        | esi^=ebx</span><br><span class="line"><span class="number">004</span>ECEE7         | <span class="number">40</span>              | inc eax                                            | eax++</span><br><span class="line"><span class="number">004</span>ECEE8         | <span class="number">4</span>A              | dec edx                                            | edx--</span><br><span class="line"><span class="number">004</span>ECEE9         | <span class="number">75</span> E3           | jne 月に寄りそう乙女の作法<span class="number">22.4</span>ECECE                           | 使用文件名算出了一个（两个？esi ebx）hash</span><br><span class="line"><span class="number">004</span>ECEEB         | <span class="number">8B</span>45 <span class="number">08</span>         | mov eax,dword ptr ss:[ebp+<span class="number">0x8</span>]                     |</span><br><span class="line"><span class="number">004</span>ECEEE         | <span class="number">8B</span>40 FC         | mov eax,dword ptr ds:[eax<span class="number">-0x4</span>]                     | eax=数据大小</span><br><span class="line"><span class="number">004</span>ECEF1         | <span class="number">35</span> DC328F00     | <span class="keyword">xor</span> eax,<span class="number">0x8F32DC</span>                                   |</span><br><span class="line"><span class="number">004</span>ECEF6         | <span class="number">33</span>C3            | <span class="keyword">xor</span> eax,ebx                                        |</span><br><span class="line"><span class="number">004</span>ECEF8         | <span class="number">03</span>C3            | add eax,ebx                                        | eax=eax^ebx^<span class="number">0x8F32DC</span>+ebx</span><br><span class="line"><span class="number">004</span>ECEFA         | <span class="number">8B</span>55 <span class="number">08</span>         | mov edx,dword ptr ss:[ebp+<span class="number">0x8</span>]                     |</span><br><span class="line"><span class="number">004</span>ECEFD         | <span class="number">0342</span> FC         | add eax,dword ptr ds:[edx<span class="number">-0x4</span>]                     | eax=eax+数据大小</span><br><span class="line"><span class="number">004</span>ECF00         | <span class="number">8B</span>55 <span class="number">08</span>         | mov edx,dword ptr ss:[ebp+<span class="number">0x8</span>]                     |</span><br><span class="line"><span class="number">004</span>ECF03         | <span class="number">8B</span>52 FC         | mov edx,dword ptr ds:[edx<span class="number">-0x4</span>]                     | edx=数据大小</span><br><span class="line"><span class="number">004</span>ECF06         | <span class="number">81E2</span> FFFFFF00   | <span class="keyword">and</span> edx,<span class="number">0xFFFFFF</span>                                   | edx=edx &amp; <span class="number">0xFFFFFF</span></span><br><span class="line"><span class="number">004</span>ECF0C         | <span class="number">8B</span>CA            | mov ecx,edx                                        | edx:<span class="string">&quot;l;p&quot;</span></span><br><span class="line"><span class="number">004</span>ECF0E         | <span class="number">03</span>D2            | add edx,edx                                        | edx:<span class="string">&quot;l;p&quot;</span></span><br><span class="line"><span class="number">004</span>ECF10         | <span class="number">03</span>D2            | add edx,edx                                        | edx:<span class="string">&quot;l;p&quot;</span></span><br><span class="line"><span class="number">004</span>ECF12         | <span class="number">03</span>D2            | add edx,edx                                        | edx=edx*<span class="number">8</span></span><br><span class="line"><span class="number">004</span>ECF14         | <span class="number">2B</span>D1            | sub edx,ecx                                        | edx=edx-数据大小</span><br><span class="line"><span class="number">004</span>ECF16         | <span class="number">03</span>C2            | add eax,edx                                        | eax+=edx</span><br><span class="line"><span class="number">004</span>ECF18         | <span class="number">8B</span>55 <span class="number">08</span>         | mov edx,dword ptr ss:[ebp+<span class="number">0x8</span>]                     |</span><br><span class="line"><span class="number">004</span>ECF1B         | <span class="number">3342</span> <span class="number">0</span>C         | <span class="keyword">xor</span> eax,dword ptr ds:[edx+<span class="number">0xC</span>]                     | 异或了一个奇怪的值 <span class="comment">//这个奇怪的值就是之前最早算的hash</span></span><br><span class="line"><span class="number">004</span>ECF1E         | <span class="number">03F</span>0            | add esi,eax                                        |</span><br><span class="line"><span class="number">004</span>ECF20         | <span class="number">8B</span>C6            | mov eax,esi                                        |</span><br><span class="line"><span class="number">004</span>ECF22         | <span class="number">25</span> FFFFFF00     | <span class="keyword">and</span> eax,<span class="number">0xFFFFFF</span>                                   | eax=(eax+esi)&amp;<span class="number">0xFFFFFF</span></span><br><span class="line"><span class="number">004</span>ECF27         | <span class="number">8</span>D04C0          | lea eax,dword ptr ds:[eax+eax*<span class="number">8</span>]                   | eax=eax*<span class="number">9</span></span><br><span class="line"><span class="number">004</span>ECF2A         | <span class="number">8B</span>C8            | mov ecx,eax                                        |</span><br><span class="line"><span class="number">004</span>ECF2C         | <span class="number">8B</span>55 F8         | mov edx,dword ptr ss:[ebp<span class="number">-0x8</span>]                     | 循环次数</span><br><span class="line"><span class="number">004</span>ECF2F         | <span class="number">8B</span>45 FC         | mov eax,dword ptr ss:[ebp<span class="number">-0x4</span>]                     | 输出的缓冲区</span><br><span class="line"><span class="number">004</span>ECF32         | E8 <span class="number">09F</span>FFFFF     | call 月に寄りそう乙女の作法<span class="number">22.4</span>ECE40                          |</span><br><span class="line"><span class="number">004</span>ECF37         | <span class="number">5F</span>              | pop edi                                            | edi:<span class="string">&quot;0yC&quot;</span></span><br><span class="line"><span class="number">004</span>ECF38         | <span class="number">5</span>E              | pop esi                                            |</span><br><span class="line"><span class="number">004</span>ECF39         | <span class="number">5B</span>              | pop ebx                                            |</span><br><span class="line"><span class="number">004</span>ECF3A         | <span class="number">59</span>              | pop ecx                                            |</span><br><span class="line"><span class="number">004</span>ECF3B         | <span class="number">59</span>              | pop ecx                                            |</span><br><span class="line"><span class="number">004</span>ECF3C         | <span class="number">5</span>D              | pop ebp                                            |</span><br><span class="line"><span class="number">004</span>ECF3D         | C3              | ret                                                |</span><br></pre></td></tr></table></figure>

<p>写成c++代码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">DWORD* <span class="title">dencrypt3_hash</span><span class="params">(<span class="type">int</span> hashlen,<span class="type">int</span> datalen,<span class="type">void</span>* filename,<span class="type">int</span> character_count,DWORD hash)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    DWORD key1 = <span class="number">0x85F532</span>; <span class="comment">//ebx</span></span><br><span class="line">    DWORD key2 = <span class="number">0x33F641</span>; <span class="comment">//esi</span></span><br><span class="line">    WORD* character = (WORD*)filename;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; character_count; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        key1 = key1 + (*character &lt;&lt; (i &amp; <span class="number">7</span>));</span><br><span class="line">        key2 ^= key1;</span><br><span class="line">        character++;</span><br><span class="line">    &#125;</span><br><span class="line">    DWORD key3 = (datalen ^ key1 ^ <span class="number">0x8F32DC</span>) + key1 + datalen; <span class="comment">//eax</span></span><br><span class="line">    DWORD key4 = ((datalen &amp; <span class="number">0xFFFFFF</span>) &lt;&lt; <span class="number">3</span>) - datalen; <span class="comment">//edx</span></span><br><span class="line">    key3 += key4;</span><br><span class="line">    key3 ^= hash;</span><br><span class="line">    key3 = ((key3 + key2) &amp; <span class="number">0xFFFFFF</span>) * <span class="number">9</span>;</span><br><span class="line">    <span class="comment">//第二个计算函数</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> rax = key3;</span><br><span class="line">    DWORD* result = <span class="keyword">new</span> DWORD[hashlen];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; hashlen; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        rax = (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)(rax ^ <span class="number">0x8DF21431</span>u) * (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)<span class="number">0x8DF21431</span>u;</span><br><span class="line">        rax = ((rax &amp; <span class="number">0xFFFFFFFF00000000</span>) &gt;&gt; <span class="number">32</span>) + (rax &amp; <span class="number">0xFFFFFFFF</span>);</span><br><span class="line">        rax = rax &amp; <span class="number">0xFFFFFFFF</span>;</span><br><span class="line">        result[i] = rax;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后是dencrypt3<br>关键的代码是这部分</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">004ED02B         | 59              | pop ecx                                            |</span><br><span class="line">004ED02C         | 8B45 08         | mov eax,dword ptr ss:[ebp+0x8]                     |</span><br><span class="line">004ED02F         | 8B40 FC         | mov eax,dword ptr ds:[eax-0x4]                     | [eax-4]:L&quot;甄Cа&quot;</span><br><span class="line">004ED032         | C1E8 03         | shr eax,0x3                                        | eax=数据大小&gt;&gt;3</span><br><span class="line">004ED035         | 8945 FC         | mov dword ptr ss:[ebp-0x4],eax                     |</span><br><span class="line">004ED038         | 837D FC 00      | cmp dword ptr ss:[ebp-0x4],0x0                     | 数据大小 &gt;&gt; 3 等于0就结束</span><br><span class="line">004ED03C         | 74 73           | je 月に寄りそう乙女の作法22.4ED0B1                            |</span><br><span class="line">004ED03E         | 8B45 08         | mov eax,dword ptr ss:[ebp+0x8]                     |</span><br><span class="line">004ED041         | 8B40 F8         | mov eax,dword ptr ds:[eax-0x8]                     |</span><br><span class="line">004ED044         | 8945 F4         | mov dword ptr ss:[ebp-0xC],eax                     |</span><br><span class="line">004ED047         | 8D85 F0FEFFFF   | lea eax,dword ptr ss:[ebp-0x110]                   | eax = 刚刚算出hash的指针</span><br><span class="line">004ED04D         | 8945 F0         | mov dword ptr ss:[ebp-0x10],eax                    |</span><br><span class="line">004ED050         | 8B85 24FFFFFF   | mov eax,dword ptr ss:[ebp-0xDC]                    | 相当于取了算出的hash指针+0x34的DWORD key1</span><br><span class="line">004ED056         | 83E0 0F         | and eax,0xF                                        |</span><br><span class="line">004ED059         | 03C0            | add eax,eax                                        |</span><br><span class="line">004ED05B         | 03C0            | add eax,eax                                        |</span><br><span class="line">004ED05D         | 03C0            | add eax,eax                                        | key1 = (val &amp; 0xF) &lt;&lt; 3</span><br><span class="line">004ED05F         | 8945 F8         | mov dword ptr ss:[ebp-0x8],eax                     |</span><br><span class="line">004ED062         | 50              | push eax                                           |</span><br><span class="line">004ED063         | 53              | push ebx                                           |</span><br><span class="line">004ED064         | 51              | push ecx                                           |</span><br><span class="line">004ED065         | 52              | push edx                                           | edx:&quot;l;p&quot;</span><br><span class="line">004ED066         | 56              | push esi                                           |</span><br><span class="line">004ED067         | 57              | push edi                                           | edi:&quot;0yC&quot;</span><br><span class="line">004ED068         | 8B4D FC         | mov ecx,dword ptr ss:[ebp-0x4]                     | ecx=数据大小&gt;&gt;3</span><br><span class="line">004ED06B         | 8B55 F8         | mov edx,dword ptr ss:[ebp-0x8]                     | edx = key1</span><br><span class="line">004ED06E         | 8B7D F4         | mov edi,dword ptr ss:[ebp-0xC]                     | edi指向了要解密的数据</span><br><span class="line">004ED071         | 8B75 F0         | mov esi,dword ptr ss:[ebp-0x10]                    | esi指向之前算出的hash</span><br><span class="line">004ED074         | 0F6F7E 18       | movq mm7,qword ptr ds:[esi+0x18]                   | mm7 = *(QWORD*)(hash+0x18)</span><br><span class="line">004ED078         | 8D0432          | lea eax,dword ptr ds:[edx+esi]                     |</span><br><span class="line">004ED07B         | 0F6F30          | movq mm6,qword ptr ds:[eax]                        | mm6 = *(QWORD*)(hash+key1)</span><br><span class="line">004ED07E         | 0FEFFE          | pxor mm7,mm6                                       | mm7 ^= mm6</span><br><span class="line">004ED081         | 0FFEFE          | paddd mm7,mm6                                      |</span><br><span class="line">004ED084         | 0F6F07          | movq mm0,qword ptr ds:[edi]                        | mm0 = data</span><br><span class="line">004ED087         | 0FEFC7          | pxor mm0,mm7                                       | mm0 ^= mm7</span><br><span class="line">004ED08A         | 0F6FC8          | movq mm1,mm0                                       | mm1 = mm0</span><br><span class="line">004ED08D         | 0F7F07          | movq qword ptr ds:[edi],mm0                        | 解密3写入数据</span><br><span class="line">004ED090         | 0FFCF9          | paddb mm7,mm1                                      |</span><br><span class="line">004ED093         | 0FEFF9          | pxor mm7,mm1                                       |</span><br><span class="line">004ED096         | 0F72F7 01       | pslld mm7,0x1                                      |</span><br><span class="line">004ED09A         | 0FFDF9          | paddw mm7,mm1                                      |</span><br><span class="line">004ED09D         | 83C7 08         | add edi,0x8                                        | edi:&quot;0yC&quot;</span><br><span class="line">004ED0A0         | 83C2 08         | add edx,0x8                                        | edx:&quot;l;p&quot;</span><br><span class="line">004ED0A3         | 83E2 7F         | and edx,0x7F                                       | key1 = (key1 + 8)&amp; 0x7F</span><br><span class="line">004ED0A6         | 49              | dec ecx                                            |</span><br><span class="line">004ED0A7         | 75 CF           | jne 月に寄りそう乙女の作法22.4ED078                           |</span><br></pre></td></tr></table></figure>

<p>写成c++</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">dencrypt3</span><span class="params">(<span class="type">void</span>* data,<span class="type">int</span> len, <span class="type">void</span>* filekey)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//0x34相当于4字节数据+0xD</span></span><br><span class="line">    DWORD key1 = (*((DWORD*)filekey + <span class="number">0xD</span>) &amp; <span class="number">0xF</span>) &lt;&lt; <span class="number">3</span>;</span><br><span class="line">    BYTE* datapos = (BYTE*)data, * fkey = (BYTE*)filekey;</span><br><span class="line">    __m64 mm7 = *((__m64*)filekey + <span class="number">0x3</span>); <span class="comment">//这里0x3相当于BYTE的0x18</span></span><br><span class="line">    __m64 mm6, mm0, mm1;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; len &gt;&gt;<span class="number">3</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        mm6 = *(__m64*)(fkey + key1);</span><br><span class="line">        mm7 = _m_pxor(mm7, mm6);</span><br><span class="line">        mm7 = _m_paddd(mm7, mm6);</span><br><span class="line">        mm0 = *(__m64*)datapos;</span><br><span class="line">        mm0 = _m_pxor(mm0, mm7);</span><br><span class="line">        mm1 = mm0;</span><br><span class="line">        *(__m64*)datapos = mm0;</span><br><span class="line">        mm7 = _m_paddb(mm7, mm1);</span><br><span class="line">        mm7 = _m_pxor(mm7, mm1);</span><br><span class="line">        mm7 = _m_pslldi(mm7, <span class="number">0x1</span>);</span><br><span class="line">        mm7 = _m_paddw(mm7, mm1);</span><br><span class="line">        datapos += <span class="number">8</span>;</span><br><span class="line">        key1 = (key1 + <span class="number">8</span>) &amp; <span class="number">0x7F</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    _m_empty();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-37.png" alt="img"><br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-38.png" alt="img"><br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-39.png" alt="img"><br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-40.png" alt="img"><br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-41.png" alt="img"><br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-42.png" alt="img"><br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-43.png" alt="img"></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BYTE* <span class="title">dencypt4_keyfilehash</span><span class="params">(<span class="type">void</span>* data,<span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span>* keyfilehash = <span class="keyword">new</span> <span class="type">int</span>[<span class="number">0x100</span>];</span><br><span class="line">    <span class="type">int</span>* keyfilehash_pos = keyfilehash;</span><br><span class="line">    <span class="comment">//keyhash初始数据的计算</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">0x100</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">3</span> ==<span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            *keyfilehash_pos = (i + <span class="number">3u</span>) * (i + <span class="number">7u</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            *keyfilehash_pos = -(i + <span class="number">3u</span>) * (i + <span class="number">7u</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        keyfilehash_pos++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> key1 = *(BYTE*)((BYTE*)data + <span class="number">0x31</span>);</span><br><span class="line">    key1 = (key1 % <span class="number">0x49</span>) + <span class="number">0x80</span>;</span><br><span class="line">    <span class="type">int</span> key2 = *(BYTE*)((BYTE*)data + <span class="number">0x1E</span> + <span class="number">0x31</span>);</span><br><span class="line">    key2 = (key2 % <span class="number">7</span>) + <span class="number">7</span>;</span><br><span class="line">    BYTE* keyfilehash_pos_byte = (BYTE*)keyfilehash;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">0x400</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        key1 = (key1 + key2) % len;</span><br><span class="line">        *keyfilehash_pos_byte ^= *(BYTE*)((BYTE*)data + key1);</span><br><span class="line">        keyfilehash_pos_byte++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (BYTE*)keyfilehash;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-44.png" alt="img"></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;mmintrin.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stack&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">FilePackVer</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> sign[<span class="number">0x10</span>];</span><br><span class="line">    DWORD filecount;</span><br><span class="line">    <span class="type">int</span> entry_low;</span><br><span class="line">    <span class="type">int</span> entry_high;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">HashData</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> sign[<span class="number">0x20</span>];</span><br><span class="line">    DWORD HashVerSize;</span><br><span class="line">    <span class="type">char</span> data[<span class="number">0x100</span>];</span><br><span class="line">    DWORD Unkown;</span><br><span class="line">    <span class="type">char</span> Blank[<span class="number">0x2F8</span>];</span><br><span class="line">    FilePackVer fpacker;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Dencrypt2DataHead</span></span><br><span class="line">&#123;</span><br><span class="line">    DWORD sign;</span><br><span class="line">    DWORD isWordType;</span><br><span class="line">    DWORD size;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Dencrypt2DataOutput</span></span><br><span class="line">&#123;</span><br><span class="line">    BYTE* data;</span><br><span class="line">    DWORD len;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">FileEntry</span></span><br><span class="line">&#123;</span><br><span class="line">    DWORD offset_low;</span><br><span class="line">    DWORD offset_hight;</span><br><span class="line">    DWORD size;</span><br><span class="line">    DWORD dencrypted_size;</span><br><span class="line">    DWORD isCompressed;</span><br><span class="line">    DWORD EncryptType; <span class="comment">// 0未加密 1第一种加密算法 2为第二种加密算法</span></span><br><span class="line">    DWORD hash;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function">DWORD <span class="title">Tohash</span><span class="params">(<span class="type">void</span>* data, <span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (len &lt; <span class="number">8</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//准备工作</span></span><br><span class="line">    __m64 mm0 = _mm_cvtsi32_si64(<span class="number">0</span>);</span><br><span class="line">    __m64 mm1;</span><br><span class="line">    __m64 mm2 = _mm_cvtsi32_si64(<span class="number">0</span>);</span><br><span class="line">    DWORD key = <span class="number">0xA35793A7</span>;</span><br><span class="line">    __m64 mm3 = _mm_cvtsi32_si64(key);</span><br><span class="line">     mm3 = _m_punpckldq(mm3, mm3);</span><br><span class="line">     __m64* pdata=(__m64*)data;</span><br><span class="line">    <span class="comment">//开始循环计算hash</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; (len &gt;&gt; <span class="number">3</span>); i++)</span><br><span class="line">    &#123;</span><br><span class="line">        mm1 = *pdata;</span><br><span class="line">        pdata++;</span><br><span class="line">        mm2 = _m_paddw(mm2, mm3);</span><br><span class="line">        mm1 = _m_pxor(mm1, mm2);</span><br><span class="line">        mm0 = _m_paddw(mm0, mm1);</span><br><span class="line">        mm1 = mm0;</span><br><span class="line">        mm0 = _m_pslldi(mm0, <span class="number">3</span>);</span><br><span class="line">        mm1 = _m_psrldi(mm1, <span class="number">0x1D</span>);</span><br><span class="line">        mm0 = _m_por(mm1, mm0);</span><br><span class="line">    &#125;</span><br><span class="line">    mm1 = _m_psrlqi(mm0, <span class="number">32</span>);</span><br><span class="line">    DWORD result = _mm_cvtsi64_si32(_m_pmaddwd(mm0, mm1));</span><br><span class="line">    _m_empty();<span class="comment">//复位浮点寄存器</span></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">dencrypt</span><span class="params">(<span class="type">void</span>* data,<span class="type">unsigned</span> <span class="type">int</span> len, DWORD hash)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (len &gt;&gt; <span class="number">3</span> == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//准备工作</span></span><br><span class="line">    DWORD key1 = <span class="number">0xA73C5F9D</span>;</span><br><span class="line">    DWORD key2 = <span class="number">0xCE24F523</span>;</span><br><span class="line">    DWORD key3 = (len + hash)^ <span class="number">0xFEC9753E</span>;</span><br><span class="line">    __m64 mm7 = _mm_cvtsi32_si64(key1);</span><br><span class="line">    mm7 = _m_punpckldq(mm7, mm7);</span><br><span class="line">    __m64 mm6 = _mm_cvtsi32_si64(key2);</span><br><span class="line">    mm6 = _m_punpckldq(mm6, mm6);</span><br><span class="line">    __m64 mm5 = _mm_cvtsi32_si64(key3);</span><br><span class="line">    mm5 = _m_punpckldq(mm5, mm5);</span><br><span class="line">    __m64* datapos = (__m64*)data;</span><br><span class="line">    __m64 mm0;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; len &gt;&gt; <span class="number">3</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        mm7 = _m_paddd(mm7, mm6);</span><br><span class="line">        mm7 = _m_pxor(mm7, mm5);</span><br><span class="line">        mm0 = *datapos;</span><br><span class="line">        mm0 = _m_pxor(mm0, mm7);</span><br><span class="line">        mm5 = mm0;</span><br><span class="line">        *datapos = mm0;</span><br><span class="line">        datapos++;</span><br><span class="line">    &#125;</span><br><span class="line">    _m_empty();<span class="comment">//复位浮点寄存器</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">Dencrypt2DataOutput* <span class="title">dencrypt2</span><span class="params">(<span class="type">void</span>* data, <span class="type">unsigned</span> <span class="type">int</span> len,<span class="type">unsigned</span> <span class="type">int</span> dencrypted_len, DWORD hash)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> Sampletable[<span class="number">0x100</span>],table[<span class="number">0x100</span>],other[<span class="number">0x100</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">0x100</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        Sampletable[i] = i;</span><br><span class="line">    &#125;</span><br><span class="line">    Dencrypt2DataHead* head = (Dencrypt2DataHead*)data;</span><br><span class="line">    <span class="comment">//对比开头是否为0xFF425031</span></span><br><span class="line">    <span class="keyword">if</span> (head-&gt;sign != <span class="number">0xFF435031</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;数据不符合解码条件&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (head-&gt;size&gt; <span class="number">0x20000000</span>u)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;数据量大于0x20000000&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    Dencrypt2DataOutput* Output = <span class="keyword">new</span> <span class="built_in">Dencrypt2DataOutput</span>();</span><br><span class="line">    Output-&gt;len = dencrypted_len;</span><br><span class="line">    Output-&gt;data = <span class="keyword">new</span> BYTE[dencrypted_len + <span class="number">1</span>];</span><br><span class="line">    BYTE* outputbuff = Output-&gt;data;</span><br><span class="line">  </span><br><span class="line">    BYTE* datapos = (BYTE*)data + <span class="built_in">sizeof</span>(Dencrypt2DataHead);</span><br><span class="line">    BYTE* data_start = datapos;</span><br><span class="line">    BYTE* data_end = (BYTE*)data + len;</span><br><span class="line">    BYTE chr;</span><br><span class="line">    <span class="type">int</span> t_pos;</span><br><span class="line">    <span class="type">int</span> size;</span><br><span class="line">    <span class="keyword">while</span> (data_start &lt; data_end)</span><br><span class="line">    &#123;</span><br><span class="line">        chr = *data_start;</span><br><span class="line">        datapos = data_start + <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">memcpy</span>(table, Sampletable, <span class="number">0x100</span>);</span><br><span class="line">        t_pos = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">//建表循环</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (chr &gt; <span class="number">0x7F</span>u)</span><br><span class="line">            &#123;</span><br><span class="line">                t_pos += chr - <span class="number">127</span>;</span><br><span class="line">                chr = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (t_pos &gt; <span class="number">0xFF</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">  </span><br><span class="line">            <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; chr + <span class="number">1</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                table[t_pos] = *datapos++;</span><br><span class="line">                <span class="keyword">if</span> (t_pos != (<span class="type">unsigned</span> __int8)table[t_pos])</span><br><span class="line">                &#123;</span><br><span class="line">                    other[t_pos] = *datapos++;</span><br><span class="line">                &#125;</span><br><span class="line">  </span><br><span class="line">                ++t_pos;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (t_pos &gt; <span class="number">0xFF</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            chr = *datapos++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//数据类型判断</span></span><br><span class="line">        <span class="keyword">if</span> ((head-&gt;isWordType &amp; <span class="number">1</span>) == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            size = *(WORD*)datapos;</span><br><span class="line">            data_start = (datapos + <span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            size = *(DWORD*)datapos;</span><br><span class="line">            data_start = (datapos + <span class="number">4</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//解密循环</span></span><br><span class="line">        stack&lt;BYTE&gt; stack;</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            BYTE result;</span><br><span class="line">            <span class="keyword">if</span> (stack.<span class="built_in">size</span>())</span><br><span class="line">            &#123;</span><br><span class="line">                result = stack.<span class="built_in">top</span>();</span><br><span class="line">                stack.<span class="built_in">pop</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (!size)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                size--;</span><br><span class="line">                result = *data_start;</span><br><span class="line">                data_start++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (result == (BYTE)table[result])</span><br><span class="line">            &#123;</span><br><span class="line">                *outputbuff = result;</span><br><span class="line">                outputbuff++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                stack.<span class="built_in">push</span>(other[result]);</span><br><span class="line">                stack.<span class="built_in">push</span>(table[result]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Output;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DencryptFileName</span><span class="params">(<span class="type">void</span>* data,<span class="type">int</span> character_count,DWORD hash)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> key = ((hash &gt;&gt; <span class="number">0x10</span>) &amp; <span class="number">0xFFFF</span>) ^ hash;</span><br><span class="line">    key = character_count ^ <span class="number">0x3E13</span> ^ key ^ (character_count * character_count);</span><br><span class="line">    DWORD ebx = key;</span><br><span class="line">    DWORD ecx;</span><br><span class="line">    WORD* datapos = (WORD*)data;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; character_count; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        ebx = ebx &lt;&lt; <span class="number">3</span>;</span><br><span class="line">        ecx = (ebx + i + key) &amp; <span class="number">0xFFFF</span>;</span><br><span class="line">        ebx = ecx;</span><br><span class="line">        *datapos = (*datapos ^ ebx) &amp; <span class="number">0xFFFF</span>;</span><br><span class="line">        datapos++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">DWORD* <span class="title">dencrypt3_hash</span><span class="params">(<span class="type">int</span> hashlen,<span class="type">int</span> datalen,<span class="type">void</span>* filename,<span class="type">int</span> character_count,DWORD hash)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    DWORD key1 = <span class="number">0x85F532</span>; <span class="comment">//ebx</span></span><br><span class="line">    DWORD key2 = <span class="number">0x33F641</span>; <span class="comment">//esi</span></span><br><span class="line">    WORD* character = (WORD*)filename;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; character_count; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        key1 = key1 + (*character &lt;&lt; (i &amp; <span class="number">7</span>));</span><br><span class="line">        key2 ^= key1;</span><br><span class="line">        character++;</span><br><span class="line">    &#125;</span><br><span class="line">    DWORD key3 = (datalen ^ key1 ^ <span class="number">0x8F32DC</span>) + key1 + datalen; <span class="comment">//eax</span></span><br><span class="line">    DWORD key4 = ((datalen &amp; <span class="number">0xFFFFFF</span>) &lt;&lt; <span class="number">3</span>) - datalen; <span class="comment">//edx</span></span><br><span class="line">    key3 += key4;</span><br><span class="line">    key3 ^= hash;</span><br><span class="line">    key3 = ((key3 + key2) &amp; <span class="number">0xFFFFFF</span>) * <span class="number">9</span>;</span><br><span class="line">    <span class="comment">//第二个计算函数</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> rax = key3;</span><br><span class="line">    DWORD* result = <span class="keyword">new</span> DWORD[hashlen];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; hashlen; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        rax = (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)(rax ^ <span class="number">0x8DF21431</span>u) * (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)<span class="number">0x8DF21431</span>u;</span><br><span class="line">        rax = ((rax &amp; <span class="number">0xFFFFFFFF00000000</span>) &gt;&gt; <span class="number">32</span>) + (rax &amp; <span class="number">0xFFFFFFFF</span>);</span><br><span class="line">        rax = rax &amp; <span class="number">0xFFFFFFFF</span>;</span><br><span class="line">        result[i] = rax;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">dencrypt3</span><span class="params">(<span class="type">void</span>* data,<span class="type">int</span> len, <span class="type">void</span>* filekey)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//0x34相当于4字节数据+0xD</span></span><br><span class="line">    DWORD key1 = (*((DWORD*)filekey + <span class="number">0xD</span>) &amp; <span class="number">0xF</span>) &lt;&lt; <span class="number">3</span>;</span><br><span class="line">    BYTE* datapos = (BYTE*)data, * fkey = (BYTE*)filekey;</span><br><span class="line">    __m64 mm7 = *((__m64*)filekey + <span class="number">0x3</span>); <span class="comment">//这里0x3相当于BYTE的0x18</span></span><br><span class="line">    __m64 mm6, mm0, mm1;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; len &gt;&gt;<span class="number">3</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        mm6 = *(__m64*)(fkey + key1);</span><br><span class="line">        mm7 = _m_pxor(mm7, mm6);</span><br><span class="line">        mm7 = _m_paddd(mm7, mm6);</span><br><span class="line">        mm0 = *(__m64*)datapos;</span><br><span class="line">        mm0 = _m_pxor(mm0, mm7);</span><br><span class="line">        mm1 = mm0;</span><br><span class="line">        *(__m64*)datapos = mm0;</span><br><span class="line">        mm7 = _m_paddb(mm7, mm1);</span><br><span class="line">        mm7 = _m_pxor(mm7, mm1);</span><br><span class="line">        mm7 = _m_pslldi(mm7, <span class="number">0x1</span>);</span><br><span class="line">        mm7 = _m_paddw(mm7, mm1);</span><br><span class="line">        datapos += <span class="number">8</span>;</span><br><span class="line">        key1 = (key1 + <span class="number">8</span>) &amp; <span class="number">0x7F</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    _m_empty();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">BYTE* <span class="title">dencypt4_keyfilehash</span><span class="params">(<span class="type">void</span>* data,<span class="type">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span>* keyfilehash = <span class="keyword">new</span> <span class="type">int</span>[<span class="number">0x100</span>];</span><br><span class="line">    <span class="type">int</span>* keyfilehash_pos = keyfilehash;</span><br><span class="line">    <span class="comment">//keyhash初始数据的计算</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">0x100</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">3</span> ==<span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            *keyfilehash_pos = (i + <span class="number">3u</span>) * (i + <span class="number">7u</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            *keyfilehash_pos = -(i + <span class="number">3u</span>) * (i + <span class="number">7u</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        keyfilehash_pos++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> key1 = *(BYTE*)((BYTE*)data + <span class="number">0x31</span>);</span><br><span class="line">    key1 = (key1 % <span class="number">0x49</span>) + <span class="number">0x80</span>;</span><br><span class="line">    <span class="type">int</span> key2 = *(BYTE*)((BYTE*)data + <span class="number">0x1E</span> + <span class="number">0x31</span>);</span><br><span class="line">    key2 = (key2 % <span class="number">7</span>) + <span class="number">7</span>;</span><br><span class="line">    BYTE* keyfilehash_pos_byte = (BYTE*)keyfilehash;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; <span class="number">0x400</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        key1 = (key1 + key2) % len;</span><br><span class="line">        *keyfilehash_pos_byte ^= *(BYTE*)((BYTE*)data + key1);</span><br><span class="line">        keyfilehash_pos_byte++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (BYTE*)keyfilehash;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">DWORD* <span class="title">dencrypt4_hash</span><span class="params">(<span class="type">int</span> hashlen, <span class="type">int</span> datalen, <span class="type">void</span>* filename, <span class="type">int</span> character_count, DWORD hash)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    DWORD key1 = <span class="number">0x86F7E2</span>; <span class="comment">//ebx</span></span><br><span class="line">    DWORD key2 = <span class="number">0x4437F1</span>; <span class="comment">//esi</span></span><br><span class="line">    WORD* character = (WORD*)filename;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; character_count; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        key1 = key1 + (*character &lt;&lt; (i &amp; <span class="number">7</span>));</span><br><span class="line">        key2 ^= key1;</span><br><span class="line">        character++;</span><br><span class="line">    &#125;</span><br><span class="line">    DWORD key3 = (datalen ^ key1 ^ <span class="number">0x56E213</span>) + key1 + datalen; <span class="comment">//eax</span></span><br><span class="line">    <span class="type">int</span> key4 = (datalen &amp; <span class="number">0xFFFFFF</span>) * <span class="number">0xD</span>; <span class="comment">//edx</span></span><br><span class="line">    key3 += key4;</span><br><span class="line">    key3 ^= hash;</span><br><span class="line">    key3 = ((key3 + key2) &amp; <span class="number">0xFFFFFF</span>) * <span class="number">0xD</span>;</span><br><span class="line">    <span class="comment">//第二个计算函数</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> rax = key3;</span><br><span class="line">    DWORD* result = <span class="keyword">new</span> DWORD[hashlen];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; hashlen; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        rax = (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)(rax ^ <span class="number">0x8A77F473</span>u) * (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)<span class="number">0x8A77F473</span>u;</span><br><span class="line">        rax = ((rax &amp; <span class="number">0xFFFFFFFF00000000</span>) &gt;&gt; <span class="number">32</span>) + (rax &amp; <span class="number">0xFFFFFFFF</span>);</span><br><span class="line">        rax = rax &amp; <span class="number">0xFFFFFFFF</span>;</span><br><span class="line">        result[i] = rax;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">dencrypt4</span><span class="params">(<span class="type">void</span>* data, <span class="type">int</span> len, <span class="type">void</span>* filekey,<span class="type">void</span>* keyfilehash)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//0x20相当于4字节数据+0x8</span></span><br><span class="line">    DWORD key1 = (*((DWORD*)filekey + <span class="number">0x8</span>) &amp; <span class="number">0xD</span>) &lt;&lt; <span class="number">3</span>;</span><br><span class="line">    BYTE* datapos = (BYTE*)data, * fkey = (BYTE*)filekey,* keyfilekey = (BYTE*)keyfilehash;</span><br><span class="line">    __m64 mm7 = *((__m64*)filekey + <span class="number">0x3</span>); <span class="comment">//这里0x3相当于BYTE的0x18</span></span><br><span class="line">    __m64 mm6, mm0, mm1,mm5;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; len &gt;&gt; <span class="number">3</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        mm6 = *(__m64*)(fkey + ((key1 &amp; <span class="number">0xF</span>) &lt;&lt; <span class="number">3</span>));</span><br><span class="line">        mm5 = *(__m64*)(keyfilekey + ((key1 &amp; <span class="number">0x7F</span>) &lt;&lt; <span class="number">3</span>));</span><br><span class="line">        mm6 = _m_pxor(mm6, mm5);</span><br><span class="line">        mm7 = _m_pxor(mm7, mm6);</span><br><span class="line">        mm7 = _m_paddd(mm7, mm6);</span><br><span class="line">        mm0 = *(__m64*)datapos;</span><br><span class="line">        mm0 = _m_pxor(mm0, mm7);</span><br><span class="line">        mm1 = mm0;</span><br><span class="line">        *(__m64*)datapos = mm0;</span><br><span class="line">        mm7 = _m_paddb(mm7, mm1);</span><br><span class="line">        mm7 = _m_pxor(mm7, mm1);</span><br><span class="line">        mm7 = _m_pslldi(mm7, <span class="number">0x1</span>);</span><br><span class="line">        mm7 = _m_paddw(mm7, mm1);</span><br><span class="line">        datapos += <span class="number">8</span>;</span><br><span class="line">        key1 = (key1 + <span class="number">1</span>) &amp; <span class="number">0x7F</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    _m_empty();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">FILE* <span class="title">WideChar_CreateFile</span><span class="params">(<span class="type">const</span> <span class="type">wchar_t</span>* filename)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">wchar_t</span>* pos = (<span class="type">wchar_t</span>*)filename;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        pos = <span class="built_in">wcschr</span>(pos, <span class="string">&#x27;\\&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (pos == <span class="literal">nullptr</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">wchar_t</span>* dir = <span class="keyword">new</span> <span class="type">wchar_t</span>[pos - filename + <span class="number">1</span>]();</span><br><span class="line">        <span class="built_in">wcsncpy</span>(dir, filename, pos - filename);</span><br><span class="line">        _wmkdir(dir);</span><br><span class="line">        pos++;</span><br><span class="line">        <span class="keyword">delete</span> dir;</span><br><span class="line">    &#125;</span><br><span class="line">    FILE* hfile = _wfopen(filename, <span class="string">L&quot;wb&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> hfile;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    string filename;</span><br><span class="line">    cin &gt;&gt; filename;</span><br><span class="line">    FILE* hfile;</span><br><span class="line">    hfile = <span class="built_in">fopen</span>(filename.<span class="built_in">c_str</span>(), <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">    <span class="comment">//获取文件大小,支持大于4GB文件</span></span><br><span class="line">    _fseeki64(hfile, <span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="type">fpos_t</span> file_size = _ftelli64(hfile);</span><br><span class="line">    <span class="comment">//读取filepack头</span></span><br><span class="line">    _fseeki64(hfile, file_size - <span class="number">0x1C</span>, <span class="number">0</span>);</span><br><span class="line">    FilePackVer* filepacker = <span class="keyword">new</span> <span class="built_in">FilePackVer</span>();</span><br><span class="line">    <span class="built_in">fread</span>(filepacker, <span class="number">0x1C</span>,<span class="number">1</span> , hfile);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">string</span>(filepacker-&gt;sign) != <span class="string">&quot;FilePackVer3.1\x00\x00&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;FilePackVer签名验证失败&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//读取HashData</span></span><br><span class="line">    HashData *hashdat = <span class="keyword">new</span> <span class="built_in">HashData</span>();</span><br><span class="line">    _fseeki64(hfile,file_size<span class="number">-0x440</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">fread</span>(hashdat,<span class="number">1</span>,<span class="number">0x440</span>,hfile);</span><br><span class="line">    <span class="comment">//数据的设置</span></span><br><span class="line">    <span class="keyword">if</span> (hashdat-&gt;Unkown &gt; <span class="number">8</span> || hashdat-&gt;Unkown &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        hashdat-&gt;Unkown = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    DWORD hash = <span class="built_in">Tohash</span>(&amp;hashdat-&gt;data,<span class="number">0x100</span>) &amp; <span class="number">0x0FFFFFFF</span>;</span><br><span class="line">    <span class="comment">//HashVer里的数据对解包并不重要 直接略过不按照程序一样去读取了</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/////////////////////////////////</span></span><br><span class="line">    <span class="comment">//解码签名</span></span><br><span class="line">    <span class="built_in">dencrypt</span>(&amp;hashdat-&gt;sign, <span class="number">0x20</span>, hash);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strncmp</span>(hashdat-&gt;sign,<span class="string">&quot;8hr48uky,8ugi8ewra4g8d5vbf5hb5s6&quot;</span>,<span class="number">0x20</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;HashData签名验证失败&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//开始解密文件</span></span><br><span class="line">     </span><br><span class="line">    DWORD64 entry = ((<span class="type">long</span> <span class="type">long</span>)filepacker-&gt;entry_high &lt;&lt; <span class="number">32</span>) + (<span class="type">long</span> <span class="type">long</span>)filepacker-&gt;entry_low;</span><br><span class="line">    BYTE* keyfilehash = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; filepacker-&gt;filecount; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        _fseeki64(hfile, entry, <span class="number">0</span>);</span><br><span class="line">        WORD character_count;</span><br><span class="line">        <span class="built_in">fread</span>(&amp;character_count, <span class="number">2</span>, <span class="number">1</span>, hfile);</span><br><span class="line">        <span class="type">wchar_t</span>* name = <span class="keyword">new</span> <span class="type">wchar_t</span>[character_count + <span class="number">1</span>]();</span><br><span class="line">        <span class="comment">//因为UTF16字节数是ASCII的两倍，所以要乘2</span></span><br><span class="line">        <span class="built_in">fread</span>(name, <span class="number">1</span>, <span class="number">2</span> * character_count, hfile);</span><br><span class="line">        <span class="comment">//解密文件名</span></span><br><span class="line">        <span class="built_in">DencryptFileName</span>(name, character_count, hash);</span><br><span class="line">        FileEntry *fentry = <span class="keyword">new</span> <span class="built_in">FileEntry</span>();</span><br><span class="line">        <span class="built_in">fread</span>(fentry, <span class="number">1</span>, <span class="number">0x1C</span>, hfile);</span><br><span class="line">        entry = _ftelli64(hfile);</span><br><span class="line">        <span class="comment">//文件名hash校检 不重要 略过</span></span><br><span class="line">  </span><br><span class="line">        <span class="comment">//文件读取</span></span><br><span class="line">        <span class="type">char</span>* filedata = <span class="keyword">new</span> <span class="type">char</span>[fentry-&gt;size];</span><br><span class="line">        _fseeki64(hfile, ((<span class="type">long</span> <span class="type">long</span>)fentry-&gt;offset_hight &lt;&lt; <span class="number">32</span>) + (<span class="type">long</span> <span class="type">long</span>)fentry-&gt;offset_low, <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">fread</span>(filedata, fentry-&gt;size, <span class="number">1</span>, hfile);</span><br><span class="line">  </span><br><span class="line">        <span class="comment">//解密文件</span></span><br><span class="line">        DWORD* filehash = <span class="literal">nullptr</span>;</span><br><span class="line">        <span class="keyword">if</span> (fentry-&gt;EncryptType == <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            filehash = <span class="built_in">dencrypt3_hash</span>(<span class="number">0x40</span>, fentry-&gt;size, name, character_count, hash);</span><br><span class="line">            <span class="built_in">dencrypt3</span>(filedata, fentry-&gt;size, filehash);</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">wcsncmp</span>(name, <span class="string">L&quot;pack_keyfile_kfueheish15538fa9or.key&quot;</span>, character_count) == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                keyfilehash = <span class="built_in">dencypt4_keyfilehash</span>(filedata, fentry-&gt;size);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(fentry-&gt;EncryptType == <span class="number">2</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            filehash = <span class="built_in">dencrypt4_hash</span>(<span class="number">0x40</span>, fentry-&gt;size, name, character_count, hash);</span><br><span class="line">            <span class="built_in">dencrypt4</span>(filedata, fentry-&gt;size, filehash, keyfilehash);</span><br><span class="line">        &#125;</span><br><span class="line">        Dencrypt2DataOutput* Output = <span class="literal">nullptr</span>;</span><br><span class="line">        <span class="keyword">if</span> (fentry-&gt;isCompressed)</span><br><span class="line">        &#123;</span><br><span class="line">            Output = <span class="built_in">dencrypt2</span>(filedata, fentry-&gt;size, fentry-&gt;dencrypted_size, hash);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Output = <span class="keyword">new</span> <span class="built_in">Dencrypt2DataOutput</span>();</span><br><span class="line">            Output-&gt;data = (BYTE*)filedata;</span><br><span class="line">            Output-&gt;len = fentry-&gt;dencrypted_size;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//保存文件</span></span><br><span class="line">        wstring filename = <span class="built_in">wstring</span>(name);</span><br><span class="line">        filename = <span class="string">L&quot;Extract\\&quot;</span> + filename;</span><br><span class="line">        FILE* hOut = <span class="built_in">WideChar_CreateFile</span>(filename.<span class="built_in">c_str</span>());</span><br><span class="line">        std::<span class="built_in">fwrite</span>(Output-&gt;data, Output-&gt;len, <span class="number">1</span>, hOut);</span><br><span class="line">        std::<span class="built_in">fclose</span>(hOut);</span><br><span class="line">        <span class="keyword">delete</span> fentry, name, filedata, filehash, Output;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    std::<span class="built_in">fclose</span>(hfile);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="实操复现"><a href="#实操复现" class="headerlink" title="实操复现"></a>实操复现</h1><p>教程是从近月2入手的 跟着一步步分析</p>
<h2 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h2><p>近月2和万华镜系列的特征一模一样<br>主文件夹下的<code>GameData</code>中的<code>xxx.pack</code>文件就是关键</p>
<p>32位PE文件<br>用IDA翻string翻出来一些特征<br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-45.png" alt="img"><br>其实这里的<code>8hr48uky,8ugi8ewra4g8d5vbf5hb5s6</code>就是验签的hash值<br>交叉引用很容易分析出这里的check<br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-46.png" alt="img"></p>
<p>再通过find_crypt发现sha256 大致能想到引擎从<code>.pack</code>解出数据后作了check检查<br>大致信息就收集这么多</p>
<h2 id="x32dbg-动态调试"><a href="#x32dbg-动态调试" class="headerlink" title="x32dbg 动态调试"></a>x32dbg 动态调试</h2><p>下面用x32dbg看 方便查看栈和寄存器的值以及对WinAPI下断点<br>发现入口地址与IDA给出的start地址一样</p>
<p>如果从入口点开始逆向分析的话工作量比较大 学习教程下API断点关注对文件的操作</p>
<h3 id="设置条件断点"><a href="#设置条件断点" class="headerlink" title="设置条件断点"></a>设置条件断点</h3><h4 id="CreateFileW"><a href="#CreateFileW" class="headerlink" title="CreateFileW"></a>CreateFileW</h4><p>通过API断点 或者搜索字符串定位到<code>74D6E570</code> 条件断点编辑如下<br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-47.png" alt="img"></p>
<p>这里的<code>esp+4</code>的偏移可以很容易通过动调在栈中看到 然后采用utf16格式输出<br>暂停条件设置为0就只会记录日志而不会暂停 可以F9一遍后看日志来分析 再缩小返回</p>
<p>同理 按教程的输出设置<code>ReadFile</code> <code>SetFilePointer</code> 的条件断点</p>
<h4 id="ReadFile"><a href="#ReadFile" class="headerlink" title="ReadFile"></a>ReadFile</h4><p>查看官方文档</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">BOOL <span class="title function_">ReadFile</span><span class="params">(</span></span><br><span class="line"><span class="params">  [in]                HANDLE       hFile,</span></span><br><span class="line"><span class="params">  [out]               LPVOID       lpBuffer,</span></span><br><span class="line"><span class="params">  [in]                DWORD        nNumberOfBytesToRead,</span></span><br><span class="line"><span class="params">  [out, optional]     LPDWORD      lpNumberOfBytesRead,</span></span><br><span class="line"><span class="params">  [in, out, optional] LPOVERLAPPED lpOverlapped</span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure>

<p>很容易看出 <code>esp+4 esp+8 esp+c</code>的结构<br>但是这里搜索遇到了直接搜不到的问题<br>解决方法是先断下<code>CreateFileW</code> 然后附近找到<code>jmp &amp;ReadFile</code> 跟踪跳转<br>设置条件断点如下:<br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-52.png" alt="img"></p>
<h4 id="SetFilePointer"><a href="#SetFilePointer" class="headerlink" title="SetFilePointer"></a>SetFilePointer</h4><p>查看Windows官方文档</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">DWORD <span class="title function_">SetFilePointer</span><span class="params">(</span></span><br><span class="line"><span class="params">  [in]                HANDLE hFile,</span></span><br><span class="line"><span class="params">  [in]                LONG   lDistanceToMove,</span></span><br><span class="line"><span class="params">  [in, out, optional] PLONG  lpDistanceToMoveHigh,</span></span><br><span class="line"><span class="params">  [in]                DWORD  dwMoveMethod</span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure>

<p>要注意这里的 高DWORD是 <code>PLONG</code>类型 即 <code>LONG</code>的指针 所以要<code>[[esp+c]]</code><br>设置条件断点如下:</p>
<p>日志分析:<br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-49.png" alt="img"></p>
<p>那么就可以按照教程的方法 在<code>CreateFileW</code>设置一个条件断点 当<code>Gamexxx</code>的时候断下来 就可以跟踪到<code>xxx.pack</code>的文件操作<br>但我设置后还是每个都断 好在文件不多 手动断到 <code>data0</code> 返回到用户领空<br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-50.png" alt="img"><br>对应到IDA其实就是这块 FileOpen (IDA可以用G快速跳转地址)<br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-51.png" alt="img"></p>
<p>当我们断到<code>data0</code>后 开启<code>ReadFile</code>的断点 来看读取了什么内容<br>发现日志输出<br><code>读取文件   句柄:3AC   缓冲:19FCDB  字节数:1C</code><br>回到用户领空<br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-53.png" alt="img"><br>有个<code>FilePackVer3.0</code>的字样<br>注意前面的<code>00 E8 FC 19</code>  小端序转一下就是 <code>19FCE8</code>  指向的正好是 <code>Filexxx</code>字串结束后的地址</p>
<p>接下来继续调试 发现就开始计算hash了<br>首先判断<code>FilePackVer</code>的版本 然后进行对应的hash操作<br>IDA可以很直观的看到<br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-54.png" alt="img"><br>进入<code>sub_4880c0</code><br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-55.png" alt="img"><br>从<code>LStrCmp</code>那里的比较往前看 <code>v17&lt;-v18&lt;-v4&lt;-v1</code><br>所以 <code>sub_483DA8</code>和<code>sub_48318C</code>都很关键</p>
<p>再前面的间接函数调用x32dbg动调可知就是 <code>FileRead</code> 而且读的是<code>data0.pack</code>的内容<br>而且在x32dbg动调的时候发现多出来一个 <code>data0.hash</code><br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-56.png" alt="img"></p>
<p>程序从<code>0019F880</code>开始读取了256数据后进入<code>sub_483DA8</code><br>里面采用的<code>MMX指令集</code><br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-57.png" alt="img"></p>
<p>sub_483DA8</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">sub_483DA8</span><span class="params">(__m64 *a1, <span class="type">unsigned</span> <span class="type">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v4; <span class="comment">// ecx</span></span><br><span class="line">  __m64 v5; <span class="comment">// mm0</span></span><br><span class="line">  __m64 v6; <span class="comment">// mm2</span></span><br><span class="line">  __m64 v7; <span class="comment">// mm3</span></span><br><span class="line">  __m64 v8; <span class="comment">// mm3</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( a2 &lt; <span class="number">8</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  v4 = a2 &gt;&gt; <span class="number">3</span>;</span><br><span class="line">  v5.m64_u64 = <span class="number">0</span>i64;</span><br><span class="line">  v6.m64_u64 = <span class="number">0</span>i64;</span><br><span class="line">  v7 = _mm_cvtsi32_si64(<span class="number">0x3070307</span>u);</span><br><span class="line">  v8 = _m_punpckldq(v7, v7);</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v6 = _m_paddw(v6, v8);</span><br><span class="line">    v5 = _m_paddw(v5, _m_pxor((__m64)a1-&gt;m64_u64, v6));</span><br><span class="line">    ++a1;</span><br><span class="line">    --v4;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v4 );</span><br><span class="line">  _m_empty();</span><br><span class="line">  <span class="keyword">return</span> _mm_cvtsi64_si32(_m_pxor(v5, _m_psrlqi(v5, <span class="number">0x20</span>u)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>返回后继续跟进 <code>sub_48318C</code><br>走的是<code>if(a3)</code>的分支<br><code>sub_48310C</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">unsigned</span> <span class="type">int</span> __cdecl <span class="title">sub_48310C</span><span class="params">(<span class="type">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// ecx</span></span><br><span class="line">  __m64 *v3; <span class="comment">// edx</span></span><br><span class="line">  __m64 v4; <span class="comment">// mm7</span></span><br><span class="line">  __m64 v5; <span class="comment">// mm7</span></span><br><span class="line">  __m64 v6; <span class="comment">// mm6</span></span><br><span class="line">  __m64 v7; <span class="comment">// mm6</span></span><br><span class="line">  __m64 v8; <span class="comment">// mm5</span></span><br><span class="line">  __m64 v9; <span class="comment">// mm5</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v10; <span class="comment">// [esp-4h] [ebp-10h]</span></span><br><span class="line"></span><br><span class="line">  result = (*(_DWORD *)(a1 + <span class="number">8</span>) + *(_DWORD *)(a1 - <span class="number">4</span>)) ^ <span class="number">0xFEC9753E</span>;</span><br><span class="line">  <span class="keyword">if</span> ( *(_DWORD *)(a1 - <span class="number">4</span>) &gt;&gt; <span class="number">3</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v10 = *(_DWORD *)(a1 - <span class="number">8</span>);</span><br><span class="line">    v2 = *(_DWORD *)(a1 - <span class="number">4</span>) &gt;&gt; <span class="number">3</span>;</span><br><span class="line">    v3 = (__m64 *)v10;</span><br><span class="line">    v4 = _mm_cvtsi32_si64(<span class="number">0xA73C5F9D</span>);</span><br><span class="line">    v5 = _m_punpckldq(v4, v4);</span><br><span class="line">    v6 = _mm_cvtsi32_si64(<span class="number">0xCE24F523</span>);</span><br><span class="line">    v7 = _m_punpckldq(v6, v6);</span><br><span class="line">    v8 = _mm_cvtsi32_si64((*(_DWORD *)(a1 + <span class="number">8</span>) + *(_DWORD *)(a1 - <span class="number">4</span>)) ^ <span class="number">0xFEC9753E</span>);</span><br><span class="line">    v9 = _m_punpckldq(v8, v8);</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      v5 = _m_pxor(_m_paddd(v5, v7), v9);</span><br><span class="line">      v9 = _m_pxor((__m64)v3-&gt;m64_u64, v5);</span><br><span class="line">      v3-&gt;m64_u64 = (<span class="type">unsigned</span> __int64)v9;</span><br><span class="line">      ++v3;</span><br><span class="line">      --v2;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v2 );</span><br><span class="line">    _m_empty();</span><br><span class="line">    result = v10;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这就很有感觉了<br>这里先跳过 ret后<code>eax:0019F85C</code> 存储的就是计算后的结果<br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-58.png" alt="img"></p>
<p>验签完过后的一堆赋值操作最开始被我忽略掉了…<br>其实仔细看会发现是跟 <code>FilePack</code>的结构体有关!!!<br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-59.png" alt="img"><br>分别取了三部分的四字节数据</p>
<p>其中出现了<code>cdq</code>指令:<br>IDA给出了定义 <code>EAX -&gt; EDX:EAX (with sign)</code><br>这是为了兼容64位寄存器的情况<br>这里把eax和edx合并了<br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-60.png" alt="img"><br>结合eax的<code>14D</code>指向的是<br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-61.png" alt="img"><br>可以猜测这个应该是结构体存储的一个跳转&#x2F;入口地址</p>
<p>大致分析一下 <code>FilePack</code>结构体的结构</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">FilePack</span>&#123;</span><br><span class="line">    <span class="type">char</span> version[<span class="number">0x10</span>]; <span class="comment">// FilePackVer3.0</span></span><br><span class="line">    DWORD Size; <span class="comment">// maybe</span></span><br><span class="line">    QWORD EntryPoint; <span class="comment">// probably </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后试着写解出来的HashData结构体也就是<code>8hrxxx</code>这一串开头的结构<br>是通过日志发现读取的0x440大小的数据就是这个<code>HashData</code><br><code>读取文件   句柄:3AC   缓冲:19F85C  字节数:440</code></p>
<p>大致观察一下结构可以注意到一个点<br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-62.png" alt="img"><br>这个<code>HashData</code>结构体的最后一个成员就是 <code>FilePack</code>结构体</p>
<p>然后后面有个<code>CopyFrom</code> 日志输出 <code>读取文件   句柄:3AC   缓冲:27BB580  字节数:14D</code><br>而指向的是 <code>HashVer1.4</code>这块<br>所以可以推出<code>8hrxx</code>0x20后的<code>4D 01 00 00</code>就是读取的字节数size</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">HashData</span>&#123;</span><br><span class="line">    <span class="type">char</span> HashHead[<span class="number">0x20</span>]; <span class="comment">// 8hrxxx</span></span><br><span class="line">    DWORD HashVerSize; <span class="comment">// 从HashVer1.4读取的字节数</span></span><br><span class="line"></span><br><span class="line">    FilePack filepack;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其他的目前还原不出来… 继续看</p>
<h3 id="HashVer的处理"><a href="#HashVer的处理" class="headerlink" title="HashVer的处理"></a>HashVer的处理</h3><p>从这里开始就很不好分析了<br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-64.png" alt="img"><br>主要是一个函数内有多种操作 步进不现实 步过又容易漏…<br>注意到<code>488201</code>处<code>CopyFrom</code>读取了Hashver部分的数据<br>后面的setpoint结合后面的<code>[eax+4]</code>知道指向了HashVer的头部 然后进入那个多功能的函数<br>在这里<br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-65.png" alt="img"><br>看到拷贝了0x20的HashVer 但是对比时只用到了0x10 所以后0x10是用于其他目的<br>然后一直对比到ver1.4<br>又进行了一次Read<br>后面对读入的数据处理<br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-66.png" alt="img"></p>
<p>后面建了一个类 然后用CopyFrom对类写入了数据<br>这里学到一个技巧 x32dbg用添加标签对函数重命名 更方便查看<br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-67.png" alt="img"><br>把 <code>sub_48318C</code>重命名为 <code>decrypt</code><br>这个是前面出现过的一个解密函数 当时解出来的就是 HashData的开头<code>8xx</code></p>
<p>然后后面又出现了一个跟<code>decrypt</code>结构很相似的解密函数 <code>decrypt2</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __fastcall <span class="title">sub_483D80</span><span class="params">(<span class="type">int</span> a1, <span class="type">char</span> a2, <span class="type">int</span> a3, <span class="type">int</span> a4)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> savedregs; <span class="comment">// [esp+8h] [ebp+0h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( a2 )</span><br><span class="line">    result = <span class="built_in">sub_483410</span>(&amp;savedregs);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    result = <span class="built_in">sub_483988</span>(&amp;savedregs);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到这里根据<code>a2</code>的不同选择不同的算法<br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-68.png" alt="img"><br>这里的eax传的是前面建的与HashVer数据有关的类 解密返回的结果也是一个类</p>
<p>前面有个很关键的点看漏了 当对<code>HashVer</code>解密后 会check<code>HashVer1.4</code>后的第5个DWORD值<br>分1,2,other 不同跳转<br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-69.png" alt="img"></p>
<p>1 就是我们的<code>decrypt2</code><br>其中decrypt2的函数<br><code>sub_483410</code>:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Classes::TStream *__cdecl <span class="title">sub_483410</span><span class="params">(<span class="type">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">char</span> *v1; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> *v2; <span class="comment">// esi</span></span><br><span class="line">  Classes::TStream *v3; <span class="comment">// ebx</span></span><br><span class="line">  <span class="type">char</span> *v4; <span class="comment">// esi</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v5; <span class="comment">// ebx</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// edi</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// ebx</span></span><br><span class="line">  <span class="type">char</span> v9[<span class="number">256</span>]; <span class="comment">// [esp+Ch] [ebp-424h]</span></span><br><span class="line">  <span class="type">char</span> v10[<span class="number">512</span>]; <span class="comment">// [esp+10Ch] [ebp-324h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v11[<span class="number">256</span>]; <span class="comment">// [esp+30Ch] [ebp-124h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v12; <span class="comment">// [esp+40Ch] [ebp-24h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v13; <span class="comment">// [esp+410h] [ebp-20h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v14; <span class="comment">// [esp+414h] [ebp-1Ch]</span></span><br><span class="line">  _BYTE *v15; <span class="comment">// [esp+418h] [ebp-18h]</span></span><br><span class="line">  Classes::TStream *v16; <span class="comment">// [esp+41Ch] [ebp-14h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v17; <span class="comment">// [esp+420h] [ebp-10h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v18; <span class="comment">// [esp+424h] [ebp-Ch]</span></span><br><span class="line">  <span class="type">int</span> v19; <span class="comment">// [esp+428h] [ebp-8h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 v20; <span class="comment">// [esp+42Fh] [ebp-1h]</span></span><br><span class="line"></span><br><span class="line">  Classes::TStream::<span class="built_in">SetPosition</span>(*(Classes::TStream **)(a1 - <span class="number">4</span>), <span class="number">0</span>i64);</span><br><span class="line">  v19 = <span class="number">0</span>;</span><br><span class="line">  v1 = v10;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    *v1++ = v19++;</span><br><span class="line">  <span class="keyword">while</span> ( v19 != <span class="number">256</span> );</span><br><span class="line">  (*(<span class="built_in">void</span> (__fastcall **)(_DWORD, <span class="type">unsigned</span> <span class="type">int</span> *, <span class="type">int</span>))(**(_DWORD **)(a1 - <span class="number">4</span>) + <span class="number">12</span>))(*(_DWORD *)(a1 - <span class="number">4</span>), &amp;v13, <span class="number">4</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v13 == <span class="number">0xFF435031</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    (*(<span class="built_in">void</span> (__fastcall **)(_DWORD, <span class="type">int</span> *, <span class="type">int</span>))(**(_DWORD **)(a1 - <span class="number">4</span>) + <span class="number">12</span>))(*(_DWORD *)(a1 - <span class="number">4</span>), &amp;v12, <span class="number">4</span>);</span><br><span class="line">    (*(<span class="built_in">void</span> (__fastcall **)(_DWORD, <span class="type">unsigned</span> <span class="type">int</span> *, <span class="type">int</span>))(**(_DWORD **)(a1 - <span class="number">4</span>) + <span class="number">12</span>))(*(_DWORD *)(a1 - <span class="number">4</span>), &amp;v17, <span class="number">4</span>);</span><br><span class="line">    v2 = (<span class="type">char</span> *)(*(_DWORD *)(*(_DWORD *)(a1 - <span class="number">4</span>) + <span class="number">4</span>) + <span class="number">12</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *(_BYTE *)(a1 - <span class="number">5</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( *(_BYTE *)(a1 + <span class="number">8</span>) )</span><br><span class="line">        System::TObject::<span class="built_in">Free</span>(*(System::TObject **)(a1 - <span class="number">4</span>));</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    v12 = <span class="number">0</span>;</span><br><span class="line">    v17 = v13;</span><br><span class="line">    v2 = (<span class="type">char</span> *)(*(_DWORD *)(*(_DWORD *)(a1 - <span class="number">4</span>) + <span class="number">4</span>) + <span class="number">4</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v17 &lt;= <span class="number">0x20000000</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v16 = (Classes::TStream *)TObject::`..<span class="number">.&#x27;</span>((VMT *)&amp;cls_Classes_TMemoryStream, <span class="number">1</span>);</span><br><span class="line">    (*(<span class="built_in">void</span> (__fastcall **)(Classes::TStream *, <span class="type">unsigned</span> <span class="type">int</span>))(*(_DWORD *)v16 + <span class="number">4</span>))(v16, v17);</span><br><span class="line">    Classes::TStream::<span class="built_in">SetPosition</span>(v16, <span class="number">0</span>i64);</span><br><span class="line">    v15 = (_BYTE *)*((_DWORD *)v16 + <span class="number">1</span>);</span><br><span class="line">    v14 = *(_DWORD *)(*(_DWORD *)(a1 - <span class="number">4</span>) + <span class="number">4</span>) + (***(<span class="built_in">int</span> (__fastcall ****)(_DWORD))(a1 - <span class="number">4</span>))(*(_DWORD *)(a1 - <span class="number">4</span>));</span><br><span class="line">LABEL_36:</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)v2 &lt; v14 )</span><br><span class="line">    &#123;</span><br><span class="line">      v20 = *v2;</span><br><span class="line">      v4 = v2 + <span class="number">1</span>;</span><br><span class="line">      <span class="built_in">idr617538_Move</span>(v10, v11, <span class="number">256</span>);</span><br><span class="line">      v5 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( v20 &gt; <span class="number">0x7F</span>u )</span><br><span class="line">        &#123;</span><br><span class="line">          v5 += v20 - <span class="number">127</span>;</span><br><span class="line">          v20 = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( v5 &gt; <span class="number">0xFF</span> )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        v6 = v20 + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">          v11[v5] = *v4++;</span><br><span class="line">          <span class="keyword">if</span> ( v5 != (<span class="type">unsigned</span> __int8)v11[v5] )</span><br><span class="line">            v10[v5 + <span class="number">256</span>] = *v4++;</span><br><span class="line">          ++v5;</span><br><span class="line">          --v6;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> ( v6 );</span><br><span class="line">        <span class="keyword">if</span> ( v5 &gt; <span class="number">0xFF</span> )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        v20 = *v4++;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( (v12 &amp; <span class="number">1</span>) == <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v18 = *(<span class="type">unsigned</span> __int16 *)v4;</span><br><span class="line">        v2 = v4 + <span class="number">2</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v18 = *(_DWORD *)v4;</span><br><span class="line">        v2 = v4 + <span class="number">4</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      v19 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( v19 )</span><br><span class="line">        &#123;</span><br><span class="line">          v7 = (<span class="type">unsigned</span> __int8)v9[--v19];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( !v18 )</span><br><span class="line">            <span class="keyword">goto</span> LABEL_36;</span><br><span class="line">          --v18;</span><br><span class="line">          v7 = (<span class="type">unsigned</span> __int8)*v2++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( v7 == (<span class="type">unsigned</span> __int8)v11[v7] )</span><br><span class="line">        &#123;</span><br><span class="line">          *v15++ = v7;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          v9[v19++] = v10[v7 + <span class="number">256</span>];</span><br><span class="line">          v9[v19++] = v11[v7];</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( *(_BYTE *)(a1 + <span class="number">8</span>) )</span><br><span class="line">      System::TObject::<span class="built_in">Free</span>(*(System::TObject **)(a1 - <span class="number">4</span>));</span><br><span class="line">    v3 = v16;</span><br><span class="line">    Classes::TStream::<span class="built_in">SetPosition</span>(v16, <span class="number">0</span>i64);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *(_BYTE *)(a1 + <span class="number">8</span>) )</span><br><span class="line">      System::TObject::<span class="built_in">Free</span>(*(System::TObject **)(a1 - <span class="number">4</span>));</span><br><span class="line">    v3 = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看出是一个比较复杂的算法 但是既然是解压函数 我们就不需要逆向算法了<br>关注下这个算法的流程<br>先计算了一个东西 然后 check <code>if ( v13 == 0xFF435031 )</code><br>然后一大堆简洁调用函数<br>接着check如果size满足条件 <code>if ( v17 &lt;= 0x20000000 )</code> …</p>
<p>结合x32dbg动调分析<br>可以知道先建了一个表 然后循环(采用的是goto)来解密<br>但并没有找到教程虽说的解密后的数据…<br>翻内存倒是翻到有jpeg字段 应该是解密了部分资源出来了<br>跳出这个函数继续往后分析</p>
<p>跳出这个函数来到这里<br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-70.png" alt="img"></p>
<p>sub_487680-&gt;decrypt3_hash</p>
<p>跟踪到这里面<br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-71.png" alt="img"><br>发现已经解出文件名了<br><img src="D:/GithubBlog/NozoBlog/source/_posts/万华镜逆向(初试)/images/image-72.png" alt="img"></p>
<p>decrypt3在IDA交叉引用很容易找到 就是 <code>sub_4878D4</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> __cdecl <span class="title">decrypt3</span><span class="params">(<span class="type">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// edi</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// esi</span></span><br><span class="line">  <span class="type">char</span> *v3; <span class="comment">// ebx</span></span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// edx</span></span><br><span class="line">  __m64 *v7; <span class="comment">// edi</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// esi</span></span><br><span class="line">  __m64 v9; <span class="comment">// mm7</span></span><br><span class="line">  __m64 v10; <span class="comment">// mm7</span></span><br><span class="line">  __m64 v11; <span class="comment">// mm1</span></span><br><span class="line">  <span class="type">int</span> v12; <span class="comment">// [esp-4h] [ebp-CCh]</span></span><br><span class="line">  <span class="type">char</span> v13[<span class="number">164</span>]; <span class="comment">// [esp+Ch] [ebp-BCh] BYREF</span></span><br><span class="line">  __m64 v14; <span class="comment">// [esp+B0h] [ebp-18h]</span></span><br><span class="line">  <span class="type">char</span> *v15; <span class="comment">// [esp+B8h] [ebp-10h]</span></span><br><span class="line">  __m64 *v16; <span class="comment">// [esp+BCh] [ebp-Ch]</span></span><br><span class="line">  <span class="type">int</span> v17; <span class="comment">// [esp+C0h] [ebp-8h]</span></span><br><span class="line">  <span class="type">int</span> v18; <span class="comment">// [esp+C4h] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  v1 = a1 - <span class="number">8</span>;</span><br><span class="line">  <span class="built_in">decrypt3_hash</span>(a1);</span><br><span class="line">  v2 = <span class="number">41</span>;</span><br><span class="line">  v3 = v13;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    *(_DWORD *)v3 = <span class="built_in">sub_4872C0</span>(*(_DWORD *)(*(_DWORD *)v1 + <span class="number">0x164</span>));</span><br><span class="line">    v3 += <span class="number">4</span>;</span><br><span class="line">    --v2;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v2 );</span><br><span class="line">  v14.m64_i32[<span class="number">0</span>] = <span class="built_in">sub_4872C0</span>(*(_DWORD *)(*(_DWORD *)v1 + <span class="number">356</span>));</span><br><span class="line">  v14.m64_i32[<span class="number">1</span>] = <span class="built_in">sub_4872C0</span>(*(_DWORD *)(*(_DWORD *)v1 + <span class="number">356</span>));</span><br><span class="line">  result = *(_DWORD *)(a1 - <span class="number">4</span>) &gt;&gt; <span class="number">3</span>;</span><br><span class="line">  v18 = result;</span><br><span class="line">  <span class="keyword">if</span> ( result )</span><br><span class="line">  &#123;</span><br><span class="line">    v16 = *(__m64 **)(a1 - <span class="number">12</span>);</span><br><span class="line">    v15 = v13;</span><br><span class="line">    v17 = <span class="number">8</span> * (<span class="built_in">sub_4872C0</span>(*(_DWORD *)(*(_DWORD *)v1 + <span class="number">356</span>)) &amp; <span class="number">0xF</span>);</span><br><span class="line">    v12 = v17;</span><br><span class="line">    v5 = v18;</span><br><span class="line">    v6 = v17;</span><br><span class="line">    v7 = v16;</span><br><span class="line">    v8 = (<span class="type">int</span>)v15;</span><br><span class="line">    v9 = v14;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      v10 = _m_paddd(_m_pxor(v9, *(__m64 *)(v6 + v8)), *(__m64 *)(v6 + v8));</span><br><span class="line">      v11 = _m_pxor((__m64)v7-&gt;m64_u64, v10);</span><br><span class="line">      v7-&gt;m64_u64 = (<span class="type">unsigned</span> __int64)v11;</span><br><span class="line">      v9 = _m_paddw(_m_pslldi(_m_pxor(_m_paddb(v10, v11), v11), <span class="number">1u</span>), v11);</span><br><span class="line">      ++v7;</span><br><span class="line">      v6 = ((_BYTE)v6 + <span class="number">8</span>) &amp; <span class="number">0x7F</span>;</span><br><span class="line">      --v5;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v5 );</span><br><span class="line">    _m_empty();</span><br><span class="line">    result = v12;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但跟教程的汇编好多对不上… gg</p>
<p>近月2到这里就结束了… 但是还有好多地方没有理清楚</p>
<p>— 太难了 —</p>
<p>但还是得继续… 想了想 也只能用x32dbg&#x2F;olldbg  IDA一不好输出日志 二不好返回用户领空<br>慢慢磨吧…</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/about/">About</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a target="_blank" rel="noopener" href="http://github.com/N0zoM1z0">Projects</a></li>
        
          <li><a href="/search/">Search</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%99%E7%A8%8B"><span class="toc-number">1.</span> <span class="toc-text">教程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E6%93%8D%E5%A4%8D%E7%8E%B0"><span class="toc-number">2.</span> <span class="toc-text">实操复现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-number">2.1.</span> <span class="toc-text">信息收集</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#x32dbg-%E5%8A%A8%E6%80%81%E8%B0%83%E8%AF%95"><span class="toc-number">2.2.</span> <span class="toc-text">x32dbg 动态调试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E6%9D%A1%E4%BB%B6%E6%96%AD%E7%82%B9"><span class="toc-number">2.2.1.</span> <span class="toc-text">设置条件断点</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CreateFileW"><span class="toc-number">2.2.1.1.</span> <span class="toc-text">CreateFileW</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ReadFile"><span class="toc-number">2.2.1.2.</span> <span class="toc-text">ReadFile</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SetFilePointer"><span class="toc-number">2.2.1.3.</span> <span class="toc-text">SetFilePointer</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HashVer%E7%9A%84%E5%A4%84%E7%90%86"><span class="toc-number">2.2.2.</span> <span class="toc-text">HashVer的处理</span></a></li></ol></li></ol></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/&text=万华镜逆向(初试)"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/&title=万华镜逆向(初试)"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/&is_video=false&description=万华镜逆向(初试)"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=万华镜逆向(初试)&body=Check out this article: http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/&title=万华镜逆向(初试)"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/&title=万华镜逆向(初试)"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/&title=万华镜逆向(初试)"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/&title=万华镜逆向(初试)"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/&name=万华镜逆向(初试)&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://n0zom1z0.github.io/%E4%B8%87%E5%8D%8E%E9%95%9C%E9%80%86%E5%90%91(%E5%88%9D%E8%AF%95)/&t=万华镜逆向(初试)"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2024
    N0zoM1z0
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
      --><li><a href="/">Home</a></li><!--
    --><!--
      --><li><a href="/about/">About</a></li><!--
    --><!--
      --><li><a href="/archives/">Writing</a></li><!--
    --><!--
      --><li><a target="_blank" rel="noopener" href="http://github.com/N0zoM1z0">Projects</a></li><!--
    --><!--
      --><li><a href="/search/">Search</a></li><!--
    -->
      </ul>
      <ul>
        
          <!-- 不蒜子统计 -->
          <span id="busuanzi_container_site_pv">
              Friend Link: Kasaki·Nozomi
          </span>
          <span class="post-meta-divider">|</span>
          <span id="busuanzi_container_site_uv" style='display:none'>
                  Yoroizuka·Mizore
          </span>
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        
      </ul>
    </nav>
  </div>
  
</footer>


    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
